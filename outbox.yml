include: [datatable, navigator]
outbox:
  type: navigator
  base_url: /outbox
  default: { url: /outbox/list_own}
  items:
    - list_own
    - list_all
    - system_outbox
    - vspace
    - $heading: { name: Schedule }
    - own_schedule
    - all_schedule
    - system_schedule
    - vspace
    - $heading: { name: Sent Items }
    - own_sent_items
    - all_sent_items
    - system_sent_items

list:
  type: datatable
  body: { max-height: 800px }
  flags: [show_titles,filter]
  class: [widest]
  sort: schedule_time
  row_actions:
    - cancel: {class: [red]}
  fields:
    - key: { show: no}
    - schedule_time: {width: 20%}
    - message: {width: 66%}
    - recipients: {width: 10%,class: [center-text], filter: no}
    - actions
  values:
    - collection.values: [session, $sid, partner, user]
  on_cancelOutbox: ~this.trigger('refresh')
  on_rescheduleOutbox: ~this.trigger('refresh')

pending_list:
  type: list
  expand:
    pages:
      - /outbox/expanded_pending_list

system_outbox:
  type: pending_list
  access: [admin]
  partner_access: merchant
  name: System Outbox
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,slide,cancel,export"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status = 'PENDING'
            and s.schedule_time <= now()
          group by s.id

list_all:
  access: admin
  type: pending_list
  name: All Outbox
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,slide,cancel,export"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status = 'PENDING'
            and s.partner_id = '$partner'
          where s.schedule_time <= now()
          group by s.id

list_own:
  type: pending_list
  name: Own Outbox
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,slide,cancel,export"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status = 'PENDING'
            and s.partner_id = '$partner'
            and s.user_id = '$user'
          where s.schedule_time <= now()
          group by s.id

reschedule:
  type: input_page
  url: /outbox/reschedule
  inputs:
    - schedule_time: {type: datetime_future,valid: datetime(future)}
  values:
    - sql_values: select schedule_time from schedule where id = '$key'
  actions:
    - reschedule
  post:
    - sql_values: select schedule_time old_date from schedule where id = '$key'
    - sql_update: [schedule,id: '$key',schedule_time]
    - sql_update: [outq,schedule_id: $key,schedule_time]
    - trigger: rescheduleOutbox
    - close_dialog: Your message was successfully rescheduled to $schedule_time
  audit:
    action: Reschedule Date
    detail: from $old_date to $schedule_time

schedule_list:
  type: pending_list
  row_actions: [reschedule: {class: [orange], action: dialog}]

own_schedule:
  type: schedule_list
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,slide,cancel,reschedule,export"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status = 'PENDING'
            and s.schedule_time > now()
            and s.partner_id = '$partner'
            and s.user_id = '$user'
          group by s.id

all_schedule:
  access: [admin]
  type: schedule_list
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,slide,cancel,reschedule,export"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status = 'PENDING'
            and s.schedule_time > now()
            and s.partner_id = '$partner'
          group by s.id

system_schedule:
  access: [admin]
  partner_access: merchant
  type: schedule_list
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,slide,cancel,export"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status = 'PENDING'
            and s.schedule_time > now()
          group by s.id

cancel:
  confirmation: yes
  post:
    - sql_values: select user_id,partner_id,credits_used,if(schedule_time>now(), "scheduled", "pending") prev_status, message from schedule where id = '$key'
    - sql_update: [schedule,id: '$key',status: "CANCELLED"]
    - sql_update: [outq,schedule_id: $key,status: "CANCELLED"]
    - if $prev_status == 'scheduled':
        - collection.insert: [credit,"",quantity: $credits_used,active: 1,partner: $partner_id,user: $user_id,time: /now(),type: "credit_note" ]
        - refresh: "#credits_available"
    - trigger: cancelOutbox
    - close_dialog: Your scheduled message was successfully cancelled
  audit:
    action: Cancel Schedule
    detail: $message

sent_list:
  type: list
  sort: schedule_time
  sort_order: desc
  row_actions:
    - type: image_row_action
    - report:
        action: redirect
        target: _blank
        desc: View detailed report
        class: [fa-file-excel-o, text-green, font-xxlarge]
  expand:
    pages:
      - /outbox/expanded_sent_list

system_sent_items:
  type: sent_list
  access: [admin]
  partner_access: merchant
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,report"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status Not In('PENDING','CANCELL')
            and s.schedule_time < now()
          group by s.id


all_sent_items:
  type: sent_list
  access: [admin]
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,report"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status Not In('PENDING','CANCELL')
            and s.schedule_time < now()
            and s.partner_id = '$partner'
          group by s.id

own_sent_items:
  type: sent_list
  values:
    - sql: >
        select s.id,s.schedule_time,s.message,count(o.id), "expand,report"  actions
          from schedule s join outq o
            on s.id = o.schedule_id and o.status Not In('PENDING','CANCELL')
            and s.schedule_time < now()
            and s.partner_id = '$partner'
            and s.user_id = '$user'
          group by s.id

expanded_list:
  type: datatable
  flags: [show_titles,filter]
  body: { max-height: 300px }
  class: [widest]
  sort: cellphone
  fields:
    - cellphone: {width: 15%}
    - contact_info: {width: 15%}
    - message: {width: 65%}

expanded_pending_list:
  name: ""
  type: expanded_list
  values:
    - sql: select msisdn,contact_info,message from outq where schedule_id = '$key'


expanded_sent_list:
  type: datatable
  flags: [show_titles,filter]
  body: { max-height: 300px }
  sort: submited_time
  fields:
    - cellphone: {width: 15%}
    - contact_info: {width: 15%}
    - message: {width: 40%}
    - submit_time: {width: 14%}
    - confirm_time: {width: 14%}
  values:
    - sql: >
        select msisdn, contact_info, message, submit_time, confirm_time
          from outq where schedule_id = '$key' and status Not In('PENDING','CANCELL')


report:
  post:
    - qmessenger.batch_report: $key
