payweb:
  on_paygate_approved:
    action: post
    post:
      - collection.values: [session, $sid, partner, user]
      - read_session: [quantity, payment: new_payment_id,amount: paygate_amount,payment_method]
      - collection.insert: [ credit,quantity, payment, active: 1,type: "purchased",amount]
      - read_config: currency,upload_dir
      - collection.values: [payment,[],counter: '/count(1)+1' ]
      - collection.values: [payment, $payment, reference1]
      - sql_values: select LPAD($counter,'6','0') counter
      - let: {invoice_number: IN$counter}
      - let: {path: $upload_dir/$invoice_number.pdf}
      - collection.insert: [document, name: Invoice Number $invoice_number, path,mime: pdf]
      - collection.update: [payment,$payment,invoice: $new_document_id]
      - qmessenger.generate_invoice: [$partner, $invoice_number, $path,$currency,$new_credit_id,$payment_method]
      - sql_values: select round($amount/100,2) amount, round(($amount - $amount/1.14)/100,2) tax
      - trigger: [paygate_processed, "", $reference1, $amount, $tax]
      - close_dialog: Your payment is being processed! Please see your payment on credit history.
      - refresh: "#credits_available"
  on_paygate_processed: |
      ~ function(e, id, amount, tax) {
          dataLayer.push({
            'transactionId': id,
            'transactionAffiliation': 'iTouch Bulk SMS',
            'transactionTotal': amount,
            'transactionTax': tax,
            'transactionProducts': [{
              'sku': 'IT01',
              'name': 'SMS credits',
              'price': amount,
              'quantity': 1
            }]
          });
        }
