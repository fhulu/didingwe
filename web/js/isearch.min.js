$.widget("didi.isearch",{options:{categoryPrefix:"-",fields:["value","name"],choose:"$name",chosen:"$name",flags:[]},_create:function(){var e=this,a=e.element,o=e.options;e.params={action:"values",path:o.path,key:o.key,offset:0,size:o.drop.autoload},e.searcher=a.find(".isearch-searcher").on("keyup input cut paste",function(){a.val(""),e.params.offset=0,e.drop.width(a.width()).show(),e._load()}),o.adder&&o.adder.url&&a.find(".isearch-adder").show().click(function(){e.drop.hide()});a.find(".isearch-dropper").click(function(){if(!$(this).hasClass("disabled"))if(e.drop.is(":visible"))e.drop.hide();else{e.params.offset=0,a.val(""),e.searcher.val(""),e._load();var o=a.offset();e.drop.css({left:o.left,top:o.top+parseInt(a.css("height").match(/\d+/))})}});e.drop=a.find(".isearch-drop").on("click",".isearch-option",function(){a.data("source",$(this).data("source")),$(this).trigger("selected",[$(this).attr("value"),$(this).attr("chosen")])}).scroll($.proxy(e._scroll,e)).click(function(){e.drop.hide()}),$(document).click(function(){e.drop.hide()}),a.on("selected",function(o,r,t){a.attr("value",r),e.searcher.val(t).select(),e.drop.hide()}).on("added",function(e,o){a.trigger("selected",[o[0],o[1]])}).click(function(e){e.stopPropagation()})},_scroll:function(e){var a=this,o=a.drop;o.scrollHeight()-o.scrollTop()!=o.height()||a._loading()||a.params.total&&a.params.offset+a.params.size>a.params.total||(a.params.offset+=a.params.size,a._load())},_loading:function(e){if(null==e)return this.drop.data("loading");this.drop.data("loading",e)},_load:function(){var e=this;if(!e._loading()){e._loading(!0);var a=e.element,o=e.options;e.params.term=e.searcher.val(),a.val(""),e.drop.width(a.width()).show();var r=(new Date).getTime();$.json(o.render.processor,{data:e.params},function(o){var t=(new Date).getTime();console.log("Load: ",t-r),o._responses&&a.triggerHandler("server_response",[o]),o.data&&(a.trigger("loaded",[o]),e._populate(o.data),e._loading(!1),delete o.data,$.extend(e.params,o),console.log("Populate: ",(new Date).getTime()-t))})}},_populate:function(e){var a=this,o=a.options,r=a.drop;a.params.offset||r.scrollTop(0).children().remove();parseInt(r.css("max-height"));a.autoScrolls=0,$.each(e,function(e,t){var i=dd.copy(o.option);i.array=t,i=o.render.initField(i,o),a._boldTerm(i,a.params.term),o.render.create(i).data("source",t).appendTo(r)})},_boldTerm:function(e,a){var o=a.split(" ");for(var r in e.embolden){var t=e.embolden[r],i=dd.escapeHtml(e[t]);for(var s in o){a=o[s].trim();""!=a&&(i=i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+$.ui.autocomplete.escapeRegex(a)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"))}e[t]=i}}});