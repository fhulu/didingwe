$.widget("didi.isearch",{options:{categoryPrefix:"-",fields:["value","name"],choose:"$name",chosen:"$name",flags:[]},_create:function(){var e=this;var a=e.element;var r=e.options;e.params={action:"values",path:r.path,key:r.key,offset:0,size:r.drop.autoload};e.searcher=a.find(".isearch-searcher").on("keyup input cut paste",(function(){a.val("");e.params.offset=0;e.drop.width(a.width()).show();e._load()}));if(r.adder&&r.adder.url)a.find(".isearch-adder").show().click((function(){e.drop.hide()}));var t=a.find(".isearch-dropper").click((function(){if($(this).hasClass("disabled"))return;if(e.drop.is(":visible")){e.drop.hide();return}e.params.offset=0;a.val("");e.searcher.val("");e._load();var r=a.offset();e.drop.css({left:r.left,top:r.top+parseInt(a.css("height").match(/\d+/))})}));e.drop=a.find(".isearch-drop").on("click",".isearch-option",(function(){a.data("source",$(this).data("source"));$(this).trigger("selected",[$(this).attr("value"),$(this).attr("chosen")])})).scroll($.proxy(e._scroll,e)).click((function(){e.drop.hide()}));$(document).click((function(){e.drop.hide()}));a.on("selected",(function(r,t,o){a.attr("value",t);e.searcher.val(o).select();e.drop.hide()})).on("added",(function(e,r){a.trigger("selected",[r[0],r[1]])})).click((function(e){e.stopPropagation()}))},_scroll:function(e){var a=this;var r=a.drop;if(r.scrollHeight()-r.scrollTop()!=r.height()||a._loading())return;if(a.params.total&&a.params.offset+a.params.size>a.params.total)return;a.params.offset+=a.params.size;a._load()},_loading:function(e){if(e==undefined)return this.drop.data("loading");this.drop.data("loading",e)},_load:function(){var e=this;if(e._loading())return;e._loading(true);var a=e.element;var r=e.options;e.params.term=e.searcher.val();a.val("");e.drop.width(a.width()).show();var t=(new Date).getTime();$.json("/",{data:e.params},(function(r){var o=(new Date).getTime();console.log("Load: ",o-t);if(r._responses)a.triggerHandler("server_response",[r]);if(!r.data)return;a.trigger("loaded",[r]);e._populate(r.data);e._loading(false);delete r.data;$.extend(e.params,r);console.log("Populate: ",(new Date).getTime()-o)}))},_populate:function(e){var a=this;var r=a.options;var t=a.drop;if(!a.params.offset)t.scrollTop(0).children().remove();var o=parseInt(t.css("max-height"));a.autoScrolls=0;$.each(e,(function(e,o){var i=dd.copy(r.option);i.array=o;i=r.render.initField(i,r);a._boldTerm(i,a.params.term);r.render.create(i).data("source",o).appendTo(t)}))},_boldTerm:function(e,a){var r=a.split(" ");for(var t in e.embolden){var o=e.embolden[t];var i=dd.escapeHtml(e[o]);for(var s in r){var a=r[s].trim();if(a=="")continue;i=i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+$.ui.autocomplete.escapeRegex(a)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")}e[o]=i}}});