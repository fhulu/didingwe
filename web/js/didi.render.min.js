(function(e){"use strict";e.render=function(t){function r(t,r){var a={every:"Interval",after:"Timeout"};for(var i in a)if(i in r){e.replaceVars(r,r[i],{recurse:!0,sourceFirst:!0});var n=[r[i].slice(1)],s=window["set"+a[i]](function(){J(void 0,t,r,n)},r[i][0]);t.data(i,s)}t.on("remove",function(){for(var e in a)e in r&&window["clear"+a[e]](t.data(e))})}var a=this;a.invoker=t.invoker;var i=a.types=t.types;a.id=t.id,a.page_id=t.id,a.options=t,a.sink=void 0,a.parent=t.parent,a.known={},a.root={},a.request=t.request,a.model={},a.model_src=t.model_src,a.model_funcs=t.model_funcs,a.processor=t.processor;var n=["type","types","template","action","attr","wrap","default"],s=["left","right","width","top","bottom","height","line-height","max-height","max-width"],o=function(e){return e.mutable||void 0===e.mutable||!1!==e.mutable},d=function(t){var r={};for(var n in t){var s=t[n],o=a.mergeType({},i[s],void 0,s);r=e.merge(r,o)}return r};this.mergeType=function(t,r,n){if(null==t||void 0===i)return t;var s;(void 0===r&&(r=t.type),void 0===r&&void 0===t.html)&&(n||(n=t.id),"string"==typeof n&&(s=n.replace(/_/g,"-")),t.classes?(r="control",i[t.classes]?r=t.classes:t.tag=t.classes,s&&(t.class=e.appendArray(t.class,s))):t.templates?(r="template",t.tag=t.templates,s&&(t.class=e.appendArray(t.class,s))):t.tag&&(r="control"));if(void 0===r)return t;r="string"==typeof r?a.mergeType(i[r],void 0,r):$.isArray(r)?d(r):a.mergeType(r);var o=e.merge(r,t);return delete o.type,o},this.expandType=function(e){return $.isPlainObject(e)?a.mergeType(e):e.search(/\W/)>=0?{html:e}:a.mergeType({type:e})};var c=function(e,t,r){var a=r.immutable;for(var i in a){var n=a[i];void 0!==t[n]&&void 0===e[n]&&(e[n]=t[n])}},l=function(t,r,a){return t?(c(r,t,a),t=e.copy(t),e.deleteKeys(t,["type","styles","style"]),e.deleteKeys(t,s),e.merge({},a,t,r)):e.merge({},a,r)},p=function(t,r,a){return!t.action&&r.action&&(t.action=r.action),r.attr&&(t.attr=e.merge({},t.attr,r.attr)),t.template||(t.template=r.template),r.default&&(t=e.merge({},r.default,t)),r.types?l(a,t,r.types.shift()):!t.type&&r.type?l(a,t,r.type):e.merge({},a,t)},u=function(e,t){for(var r=e.length;r--;){var a=e[r];(t.indexOf(a.id)>=0||"pop"==a.id)&&e.splice(r,1)}},f=function(t,r){for(var a in r){var i=r[a],n=i.push;delete i.push;var s=t.indexOf(i);i=e.copy(i),t.splice(s,1),"first"===n?t.unshift(i):"last"===n?t.push(i):"merge"==n?(s=e.firstIndexOfKey(t,"id",i.id),t[s]=e.merge({},t[s],i)):t.splice(e.firstIndexOfKey(t,"id",n),0,i)}},v=function(e){var t=[],r=[];for(var a in e){var i=e[a];$.isArray(i)||("pop"==i.id?r.push(i.name):i.push&&t.push(i),e[a]=i)}u(e,r),f(e,t)},g=function(t){for(var r in t){var a=t[r];if($.isArray(a)&&1==a.length&&(a=a[0]),"string"==typeof a)try{var i=JSON.parse(a);a=i}catch(t){a=e.toObject(a)}if($.isPlainObject(a)){var s=a.id;if(void 0===s){var o=e.firstElement(a);if(s=o[0],n.indexOf(s)>=0)continue;a=o[1],"string"==typeof a&&(a={name:a}),a=$.extend({},a)}"string"==typeof a&&(a={name:a}),a.id=s,t[r]=a}}},h=function(e,t){for(var r=0;r<t.length;++r){var a=t[r];if($.isPlainObject(a)&&"merge"===a.id){var i=e[a.name];i&&(t.splice(r,1),g(i),i.forEach(function(e,a){t.splice(r+a,0,e)}))}}};this.expandFields=function(t,r,i,n){n||(n={template:"$field"});let s=t.path?t.path+"/"+r:r;g(i),v(i),h(t,i);let d=t.sow,c=[],l=0;for(var u in i.forEach((u,f)=>{let v,g;if(c.push(f),$.isPlainObject(u)){if(B(n,u,t))return;v=u.id,"query"==v&&(u.defaults=e.copy(n)),"$"==v[0]&&(v=v.substr(1),u=e.merge({},t[v],u)),v=a.expandValue(t,v),d&&d.indexOf(v)>=0&&(u=e.merge({},t[v],u)),U(u);let r=e.copy(a.types[v]),i=r?e.merge({},r,u):u;u.id=v,o(i)?u=p(u,n,r):i&&(u=i)}else $.isArray(u)?(g=u,v=u[0],u=e.copy(n),u.array=g):console.log("Unhandled item",u,t);u.id=v,s&&!u.path&&(u.path=s+"/"+v);let h=u.template;if("none"==h||"$field"==h)delete u.template;else if("string"==typeof h){var y={};B(y,{template:h},t),u.template=y.template}n.wrap&&(u.wrap=n.wrap,u.wrap.id=r,u.wrap=this.initField(u.wrap,t),delete n.wrap),u=$.extend({index:l,number:l+1},u),++l,u=this.initField(u,t),u.template&&m(u),i[f]=u,c.pop()}),c)i.splice(c[u]-u,1)};var m=function(t){var r=t.template,i=e.copy(a.mergeType(t));for(var n in"string"==typeof r?r={html:r}:(r=a.mergeType(e.copy(r)),e.deleteKeys(i,["type","attr","action","class","tag","html","style","styles","create","classes","template","templates","text","templated","didi-functions"]),e.deleteKeys(i,s),"attr"in r||(r.attr={}),r.attr.for=t.id),i)0==n.indexOf("on_")&&delete i[n];t.template=a.initField(e.merge({},r,i)),t.template.id=""};this.expandFunction=function(e,t){var r=/(copy|css)\s*\((.+)\)/.exec(e);if(!r||r.length<1)return e;var a=r[2];return"copy"===r[1]&&(a="#"+a+" #"+t+",[name="+a+"] #"+t),$(a).value()};var y=function(e){return!e||$.isPlainObject(e)?[]:($.isArray(e)||(e=[e]),e)},x=function(t,r){return y(r).map(function(r){var a=e.getMatches(r,/\$(\w+)/g);for(var i in a){var n=a[i],s=t[n];void 0!==s&&"string"==typeof s&&(r=r.replace("$"+n,s))}return r})};this.expandValue=function(e,t){return $.each(e,function(r,a){$.isNumeric(r)||"string"!=typeof a||"string"!=typeof t||(t=t.replace(new RegExp("\\$"+r+"([^w]|\b|$)","g"),a+"$1"),e[r]=a,t.indexOf("$"))}),t},this.expandValues=function(e,t,r){if(!e)return e;var i;void 0===t&&(t=e.id);r||(r=[]);var n=$.isArray(e.constants)?e.constants:[];r=r.concat(n);do{for(var s in i=!1,e){var o=e[s];if(!$.isNumeric(o)&&($.isArray(o)&&(e[s]=x(e,o)),!("string"!=typeof o||o.indexOf("$")<0||r.indexOf(s)>=0))){var d=o=o.replace("$id",t);e[s]=o=a.expandValue(e,o,t),i=d!==o}}}while(i);return e},this.expandArray=function(t){if(t.expand_data)return t[t.expand_data]=t[t.expand_data].concat(t.array),void delete t.array;$.each(t,function(r,a){var i=e.getMatches(a,/\$(\d+)/g);for(var n in i){var s=parseInt(i[n]);a=a.replace(new RegExp("\\$"+s+"([^d]|\b|$)","g"),t.array[s-1]+"$1")}t[r]=a})},this.parentSow=function(t,r){if(!t||!t.sow)return r;for(var a in t.sow){var i=t.sow[a],n={};n[i]=t[i],r=e.merge({},n,r)}return r};var _=function(t,r){if(t){for(var a in!r.parent_id&&t.id&&(r.parent_id=t.id),!r.parent_name&&t.name&&(r.parent_name=t.name),r.derive){var i=r.derive[a],n=r[i];void 0===n?r[i]=t[i]:$.isPlainObject(n)||$.isArray(n)?r[i]=e.merge({},t[i],n):"string"==typeof n&&"$"===n[0]&&(r[i]=t[n.substr(1)])}delete r.derive}};let w=function(t){let r=t.upgrade;return r?(e.each(r,(r,a)=>{let i=t[a];void 0!==i&&(i=e.copy(i),e.each(r,(r,n)=>{let s=new RegExp(n);e.isIterable(i)?e.some(i,(e,t)=>s.test(e)||s.test(t))&&(t[a]=e.extend(t[a],r)):s.test(i)&&(t[a]+=" "+r)}))}),delete t.upgrade,t):t};this.initField=function(t,r){t.page_id=this.page_id,t.template&&t.template.subject&&(t=e.merge({},t.template.subject,t),t.template.tag||delete t.template),_(r,t),t=this.parentSow(r,t),t=this.mergeType(t);var a=t.id;t.array&&t.array.length>1&&void 0===t.name&&(t.name=t.array[1]),"string"==typeof a&&void 0===t.name&&(t.name=e.toTitleCase(a.replace(/[_\/]/g," "))),t.array?this.expandArray(t):t=M(t);var i=["template","attr","text","html"];return this.expandValues(t,t.id,i),t.template&&t.template.subject&&(_(t.template,t),this.expandValues(t,t.id,i)),void 0!==t.class&&(e.isArray(t.class)||(t.class=[t.class]),t.class=t.class.reduce((e,t)=>"string"==typeof t?e.concat(t.split(" ")):e,[])),w(t),t};var b=function(e){return["table","thead","th","tbody","tr","td"].indexOf(e)>=0},k=function(t,r){r.jquery&&(e.replaceVars(r,r.params),t.call(r.jquery,r.params))},O=function(t,r){r.template||(e.toIntValue(r,"show"),e.toIntValue(r,"hide"),r.hide||!1===r.show||0===r.show?t.hide():r.show&&t.show())},j=function(t,r){e.toIntValue(r,"disabled"),t.prop("disabled",r.disabled)};this.render=function(e,t){var r=e[t]=a.initField(e[t],e);a.root_field=r;var i=a.root=a.create(e,t,!1);return a.initModel(i,r),i.on("values",function(e,t){if($.isPlainObject(t))i.setChildren(t,!0,Q);else for(var r in t)i.setChildren(t[r],!0,Q);a.respond(t),i.trigger("update_watchers")}),i};var P=function(e,t){var r=t.responsive;if(r){var a={small:"screen and (max-width:600px)",medium:"screen and (min-width:601px) and (max-width:992px)",large:"screen and (min-width:993px)"};for(var i in a){var n=r[i];n&&enquire.register(a[i],{match:function(){e.addClass(n.join(" "))},unmatch:function(){e.removeClass(n.join(" "))}})}}},C=function(e,t){if(!$.isPlainObject(t))return e.setClass(t);O(e,t),j(e,t),P(e,t),K(e,t),R(e,t),S(e,t)};this.create=function(r,n,s,o){var d=r;if("string"==typeof n||$.isNumeric(n)?(d=r[n],d||(d=i[n])):$.isPlainObject(n)&&(d=n),(void 0===s||s)&&(d=this.initField(d,r)),void 0===d.parent_page&&(d.parent_page=a.id),d.sub_page){var c=$("<div>loading...</div>");return this.createSubPage(r[n],c),c}d.id;if(void 0===d.html)return null;d.text=this.expandValue(d,d.text),d.html=this.expandValue(d,d.html),d.html=d.html.trim().replace(/\$tag(\W)/,d.tag+"$1");var l=b(d.tag),p=l?$("<"+d.tag+">"):$(d.html);d.is_body&&(p=$("body").append(p.html())),void 0===this.sink&&(this.sink=p);var u=["id","create","css","script","name","desc","data"];te(p,d),void 0===d.key&&(d.key=t.key);for(var f=$.extend({},this.types,d),v=e.getMatches(d.html,/\$(\w+)/g),g=0,h=0;h<v.length;++h){var m=v[h],y=f[m];if(void 0!==y)if("string"==typeof y&&y.search(/\W/)<0&&u.indexOf(m)<0&&(y=f[y]||y),$.isArray(y))void 0!==this.types[m]&&(y=$.merge($.merge([],this.types[m]),y)),this.expandFields(d,m,y),g+=this.createItems(p,d,m,y);else if($.isPlainObject(y)){y.path||(y.path=d.path+"/"+m),void 0===y.id&&(y.id=m),y.parent_page=d.parent_page;var x=this.create(d,m,!0);l&&p.append(x),d.html=="$"+m?p.html("").append(x):this.replace(p,x,m)}else p.replace(new RegExp("\\$"+m+"([^w]|\b|$)?","g"),y+"$1"),this.known[m]=y}return""===p.attr("id")&&p.removeAttr("id"),p.data("didi-field",d),C(p,d),d.parent&&o&&C(o,d.parent),k(p,d),"didi-functions"in d&&p.addClass("didi-watcher"),$.isPlainObject(d.position)&&p.position(d.position),N(p,d).then(function(){g&&a.setValues(p,d),D(p,d),p.triggerHandler("created",[d])}),("string"==typeof n||$.isNumeric(n))&&(r[n]=d),p},this.createSubPage=function(e,r,a){return null==r&&(r=$("<span>").text("loading...")),delete e.sub_page,delete e.appendChild,e.path=e.url?e.url:e.id,$.showPage($.extend({request:t.request,processor:t.processor},e),r).done(function(e,t,i){if(S(e,i),R(e,i),P(e,i),r.trigger("dying"),r.replaceWith(e),a){var n=/(\.[\w-][\w-\.]*)$/g.capture(a);n.length&&e.addClass(n[0].replace("."," "))}})},this.createItems=function(e,t,r,a,i){var n,s=!1;void 0===r||t.html.trim()==="$"+r||b(t.tag)||(n=new RegExp("(\\$"+r+")"));var o,d="_new_"+r,c='<div id="'+d+'"></div>',l=0;for(var p in a){var u=a[p],f=u.id;if("query"!=f){var v;++l,n&&e.replace(n,c+"$1");var g=this.create(a,p);u.template&&(v=this.create(u,"template"))?(b(u.template.tag)?v.append(g):this.replace(v,g,f,"field"),u.parent&&C(v,u.parent)):(v=g,delete u.template),o?o.append(v):u.wrap?(o=this.create(u,"wrap"),o.html(""),e.find("#"+d).replaceWith(o),o.append(v),delete u.wrap):n?e.find("#"+d).replaceWith(v):e.append(v)}else{if(s)continue;s=!0,this.loadData(e,t,r,u.defaults)}}return!s&&n&&e.replace(n,""),l},this.replace=function(e,t,r,a){r=r||t.attr("id"),a=a||r;var i="__new__"+r.replace(/[^\w]/g,"_"),n="<div id="+i+"></div>";return e.replace("\\$"+a,n),e.find("#"+i).replaceWith(t),t},this.loadData=function(e,t,r,i){this.loading++,e.on("loaded",function(t,n,s){0==--a.loading&&a.parent.trigger("loaded",s),null!=s?(void 0===i.attr&&(i.attr={}),i.attr.loaded="",e.find("[loaded]").exists()&&e.find("[loaded]").replaceWith("$"+r),a.expandFields(n,r,s,i),a.createItems(e,n,r,s,i),0===a.loading&&a.parent.trigger("loaded",[n,s])):console.log("No page data result for object: ",a.object," field ",n.id)}),(t.autoload||void 0===t.autoload)&&$.json(a.processor,A("data",t.path+"/"+r,$.extend({},t.params,{key:t.key})),function(r){a.respond(r,e),e.trigger("loaded",[t,r.data])}),e.on("reload",function(n,s){t.autoload=!0,t.params=s,a.loadData(e,t,r,i),t.values&&a.loadValues(e,t)})};var A=function(e,r,i){return r||(r=a.path),{data:$.extend({},t.request,{key:t.key},i,{action:e,path:r})}},V=function(e){},F=function(e,t){if(t.listen){var r=$.isArray(t.listen)?t.listen:[t.listen];$.each(r,function(r,a){e.on(a,function(r,...i){e.trigger(a+"_"+t.id,[i])})})}},E=function(t,r){let i={};r.action&&(i.click=[r]);let n=r.id;F(t,r),$.each(r,function(e,r){if(0==e.indexOf("on_")){var a=e.substr(3);a in i||(i[a]=[]),$.isArray(r)?i[a]=i[a].concat(r):i[a].push(r),t.hasClass("didi-listener")||t.addClass("didi-listener")}}),$.each(i,function(i,s){$.each(s,function(s,o){$.isPlainObject(o)&&!o.path&&(o.path=r.path+"/on_"+i);var d=t;t.is("body")&&["scroll","resize"].indexOf(i)>=0&&(d=$(window));var c="on_"+i.replace(/\W/g,"_"),l=i.split("@"),p=l[0],u=l.length>1?l[1]:null;d.on(p,u,function(i){if(!t.hasClass("disabled"))if("click"==p&&"a"==t.prop("tagName").toLowerCase()&&(i.preventDefault(),void 0===r.url&&(r.url=t.attr("href"))),$.isPlainObject(o)){var s=Array.prototype.slice.call(arguments,1);o.params=e.merge({},o.params,s),e.replaceVars(o,o.params),J(i,t,o)}else if("didi-model"in r&&c in r["didi-model"]){var d=a.model[c+"_"+n];d&&d.apply(t,arguments),a.updateWatchers()}})})})},I=function(e,t){var r=y(t.trap);$.each(r,function(t,r){e.on(r,function(e){e.stopPropagation()})})},T=function(t,r){let a=r.triggers;if(!a)return;let i=this;$.each(a,function(r,a){e.asArray(a).forEach(function(a){let n,s=t,o=[];if("string"==typeof a)n=a;else{if(!$.isPlainObject(a))throw"triggered event must be either a string on an object";{[n,o]=e.firstElement(a),o=e.asArray(o);let r=o.shift();if(r){let[e,a,n,o]=/^(?:(self)|(parent)|(page)) (.*)$/g.capture(r);a?s=t.parent():n?s=i.root:e||(s=$(r)),o&&(s=s.find(o))}}}t.on(r,function(e,...t){s.triggerEx(n,[...o,...t])})})})},q=function(e,t){var r,a,i=y(t.toggles),n="click";switch(i.length){case 0:return;case 1:r=i[0];break;case 2:r=i[0],a=i[1];break;default:r=i[0],a=i[1],n=i[3]}e.on(n,function(){r==a?e.toggleClass(r):e.hasClass(r)?e.removeClass(r).addClass(a):e.removeClass(a).addClass(r)})},W=function(e,t){var r=t.events;r&&e.on(Object.keys(r).join(" "),function(t){e.setClass(r[t.type])})},D=function(e,t){if(q(e,t),W(e,t),!("attr"in t&&t.attr.for==t.id)){T(e,t),I(e,t),r(e,t),E(e,t),"string"==typeof t.enter&&e.keypress(function(r){13===r.keyCode&&e.find(t.enter).click()}),t.page_id=a.page_id,e.on("reload",function(r,a){t.params=a,Y(e,t)}).on("server_response",function(e,t){e.stopImmediatePropagation(),a.respond(t)}),V(e),e.on("post",function(e,r){t=$.extend({},t,{action:"post",params:[r]}),J(e,$(this),t)});var i=e.prop("tagName");if(i&&!(["input","select","textarea"].indexOf(i.toLowerCase())<0)){var n=ee(t);e.on("keyup input cut paste change",function(){let t=e.value(),r=""===t?"clear":"set";e.trigger(r);let i=a.model["set_"+n];i&&!i(t)||a.updateWatchers({invoker:e})})}}},N=function(e,t){return $.when(L("css",t),L("script",t)).then(function(r,i){t.create&&e.customCreate($.extend({render:a},t))})},K=function(t,r){e.replaceVars(r,r.attr,{sourceFirst:!0,recurse:!0});var a=r.attr;""===t.attr("id")&&t.removeAttr("id"),a&&("string"==typeof a?t.attr(a,""):$.each(a,function(a,i){if(r.array){var n=e.getMatches(i,/\$(\d+)/g);n.length&&(i=r.array[n[0]-1])}var s=e.getMatches(i,/\$(\w+)/g);for(var o in s){var d=s[o],c=r[d];void 0!==c&&"string"==typeof c&&(i=i.replace("$"+d,c))}t.attr(a,i)}),""===t.attr("id")&&t.removeAttr("id"))},R=function(e,t){e.setClass(x(t,t.class))},S=function(t,r){var i=r.immutable,n=function(){for(var t in"string"==typeof c&&(c=a.mergeType({},c.split(/[\s,]+/))),c){var r=a.mergeType({},c[t]);e.deleteKeys(r,i),$.extend(d,r)}},o=function(){for(var e in s){var t=s[e];if(!(i&&i.indexOf(t)>=0)){var a=r[t];void 0!==a&&"$"!==a[0]&&(d[t]=a)}}},d=r.style;d||(d={});var c=r.styles;c&&n(),e.replaceVars(r,d,{sourceFirst:!0,recurse:!0}),e.replaceVars(d,d,{sourceFirst:!0,recurse:!0}),o(),t.css(d)},M=function(t){var r=[];return $.each(t,function(e,t){"string"==typeof t&&t.match(/^\$\d+$/)&&r.push(e)}),e.deleteKeys(t,r),t},z=function(t,r,a){var i=t[r];return $.isPlainObject(i)?a=e.merge({},i,a):"string"==typeof a&&(a.type=i),a},B=function(t,r,i){if(1!=e.size(r))return!1;var s=i.sow,o=!1;for(var d in n){var c=n[d],l=r[c];if(void 0!==l&&("$"==l[0]&&(l=i[l.substring(1)]),void 0!==l)){if(s&&s.indexOf(l)>=0&&(l=e.merge({},i[l],t[c])),"template"===c&&"none"===l)l="$field";else if("wrap"===c&&$.isPlainObject(l))l=$.extend({},{tag:"div"},l);else if("type"===c||"template"===c||"wrap"===c)void 0===l&&console.log("undefined value",c,r),l=a.expandType(l);else if("types"===c){var p=[];for(var d in l)p.push(a.expandType(l[d]));l=p}"template"==c&&$.isPlainObject(r[c])&&void 0===r[c].type&&(l=z(t,c,a.initField(l)),e.replaceVars(l,l.subject,{recurse:!0})),t[c]=l,o=!0}}return U(t),o},L=function(e,t){var r=t[e];return"string"==typeof r&&(r=r.split(",")),null==r||0==r.length?$.when():$.when.apply($,$.map(r,function(t){return $.loadLink(t,e)}))},U=function(e){var t=e.attr;if(void 0!==t&&!$.isPlainObject(t)){var r={};return r[t]=t,e.attr=r,e}},H=function(r){$.isPlainObject(r)||(r={url:r}),e.replaceVars(r,r);var i=r.url;if((!i||r.query)&&"_blank"===r.target){i="/?action=action",r=$.extend({key:t.key},r);var n=["action","desc","html","id","name","page_id","query","selector","tag","target","text","type","template"];for(var s in r){var o=r[s];$.isPlainObject(o)||$.isArray(o)||n.indexOf(s)>=0||(i+="&"+s+"="+encodeURIComponent(r[s]))}}i&&(/^[\w]+:\//.test(i)||(i=r.processor+"/"+i),"_blank"===r.target?window.open(i,r.target):r.target?($.closeDialog(a.sink),a.createSubPage({url:i,key:r.key},$(r.target),r.target)):document.location=i)},J=function(e,t,r,i){r.page_id=r.page_id||t.closest(".page").attr("id");var n=function(e){var r=e&&$.isPlainObject(e._responses)&&"errors"in e._responses?"error":"success";t.trigger("post_"+r,[e])},s=function(i){var s=[];switch($.isArray(i)&&(s=i.slice(1),i=i[0]),!r.url&&["dialog","redirect"].includes(i)&&(r.url=r.path.split("/")[0]+"/"+r.id),i){case"page":return void $.showPage($.extend({processor:a.processor},r));case"dialog":return void $.showDialog(r.url,$.extend({key:r.key,processor:a.processor},s[0]));case"close_dialog":$.closeDialog(t);break;case"redirect":H(r);break;case"post":var o=r.url?r.url:r.path;s=A("action",o,{key:r.key});var d=r.selector||"#page *";d=d.replace(/(^[^\w]+)page([^\w]+)/,"$1"+r.page_id+"$2"),s=$.extend(s,{invoker:t,event:e,async:!0,post_prefix:r.post_prefix}),a.sink.find(".error").remove(),a.sink.find(".in-error").unsetClass("in-error").trigger("clear-error"),t.trigger("posting",[s]),$(d).json(a.processor,s,function(r){n(r),a.respond(r,t,e)});break;case"trigger":Z(r,t);break;default:i&&"."==i[0]&&t[i.substring(1)].apply(t,s)}},o=function(){void 0===i&&(i=r.action),$.isArray(i)?i.forEach(s):s(i)};!r.confirmation||i?o():$.showDialog("/confirm_dialog",{processor:a.processor}).done(function(e){"string"==typeof r.confirmation&&e.find("#message").text(r.confirmation),e.find(".action").click(function(){$.closeDialog(e),"yes"===$(this).attr("action")&&o()})})},X=function(e,t){if("alert"!=e){var r,i=a.sink.find("#"+e+",[name='"+e+"']");if(i.hasClass("error-sink"))r=i;else{var n=i.parents(".error-sink");n.exists()||(n=i.parents("[for='"+e+"']")),r=n.exists()?n.eq(0):i}if(i.trigger("errors",[t]),r.addClass("in-error").attr("error-message",t),!r.hasClass("no-error-box")&&!i.hasClass("no-error-box")){var s=$("<div class=error>"+t+"</div>");r.after(s);var o=parseInt(r.css("z-index"));s.css("z-index",o+1),s.fadeIn("slow").click(function(){$(this).fadeOut("slow")})}}else alert(t)},G=function(e,t){for(var r in e)X(r,e[r]);t&&t.stopImmediatePropagation()};this.respond=function(t,r,i){if(t){e.removeXSS(t);var n=t._responses;if(delete t._responses,!$.isPlainObject(n))return this;var s=a.sink;r?(s=r.parents("#"+a.page_id).eq(0),s.exists()||(s=a.sink)):r=s;var o=function(e,t){switch(e){case"alert":alert(t);break;case"show_dialog":$.showDialog(t,$.extend({processor:a.processor},n.options));break;case"close_dialog":$.closeDialog(s,t);break;case"redirect":H(t);break;case"update":s.setChildren(t,!0);break;case"trigger":Z(t,s);break;case"error":X(t);break;case"errors":G(t)}};for(var d in n){var c=n[d];if($.isArray(c))for(var l in c)o(d,c[l]);else o(d,c)}}},this.setValues=function(t,r){var a;for(var i in r.values){var n=r.values[i],s=$.isNumeric(i);if(!s||$.isPlainObject(n)){var o=i,d=n;if(s){var c=e.firstElement(n);o=c[0],n=c[1]}var l=t.find(e.selector.idName(o));l.exists()?l.value(d):"query"===o&&(a=!0)}}a&&(t.on("load_values",function(e,r){Y(t,r)}),(void 0===t.auto_load||t.auto_load)&&t.trigger("load_values",[r]))};var Q=function(e,t){t=t||{update_watchers:!0};let r=e.data("didi-field");if(!r||!r.id)return;var i=a.model["set_"+r.id];let n=e.value();e.trigger(""===n?"clear":"set"),i&&!i(n)||!t.update_watchers||a.updateWatchers({invoker:e})},Y=function(e,t){var r=$.extend({key:t.key},t.params);$.json(a.processor,A("values",t.path,r),function(t){t&&e.trigger("values",[t])})},Z=function(e,t){var r;e.event||(e.event=e.id);var i,n=e.event;if($.isPlainObject(n)?(r=n.sink,a.expandValues(n.parameters,e.id),i=n.parameters,n=n.name):(r=e.sink,i=e.params,void 0===i||$.isArray(i)||(i=[i]),("toggle"==n||".toggle"==n&&void 0!==i)&&(i=[1===parseInt(i[0])||!0===i[0]])),r){var s=r;r=$(r.replace(/(^|[^\w]+)page([^\w]*)/,"$1"+a.id+"$2")),r.exists()||(r=window.parent.$(s))}else r=t||$(".didi-listener");"loaded_values"==n&&console.log("loaded_values",r,i),r.triggerEx(n,i)},ee=function(e){return e.attr&&"radio"==e.attr.type?e.attr.name:e.id},te=function(e,t){function r(e,t,r){var a;r=r.trim(),a=/^~|\s*function\s*\([^)]*\)/gm.test(r)?[r]:/(`[^`]+`)/g.capture(r);var i=!1;t=t.replace(/\W/g,"_"),a.forEach(function(e,a){if(e){var n,c="\n\t}",l=/\breturn\s/gm.test(e)?"":"\t\treturn ";0!=t.indexOf("on_")?n="\tget_"+d+"_"+o+": function(obj) {\n"+l:/^[~`]?\s*function\s*\(/gm.test(e)?(n="\t"+t+"_"+d+": ",c=""):n="\t"+t+"_"+d+": function(event) {\n",n+=e.replace(/^~|`/g,"")+c,s.push(n),r=r.replace(e,"${"+o+"}"),i=!0,++o}}),i&&(e["didi-model"][t]=r)}function a(t,r){for(var a in r){var i=r[a].script;if(!i)return;/^[~`]?\s*function\s*\(/gm.test(i)&&(i="function(event) { "+i+" }");var n=e;e.is("body")&&"scroll"==t&&(n=$(window)),n.on(t,$.proxy(Function(i),e))}}function i(e,t){if("html"!=t){var i=e[t];"string"==typeof i?r(e,t,i):0==t.indexOf("on_")&&$.isArray(i)&&a(t.substr(3),i)}}function n(e){if(e)for(var t in e["didi-model"]={},e)i(e,t)}var s=[],o=0,d=t.id;n(t),n(t.style),n(t.class),s.length&&(t["didi-functions"]=s)};this.initModel=function(e,t){var r=[],i=t.id;t.dd_init&&$.each(t.dd_init,function(e,t){r.push(e)}),e.find("input,select,textarea,.isearch").addBack("input,select,textarea,.isearch").each(function(){var e=$(this).data("didi-field");if(e&&e.parent_page==i){var t=ee(e);r.indexOf(t)<0&&r.push(t)}});var n=r.map(function(e){return"\tset_"+e+": function(x) {\n\t\tvar changed = ("+e+" !== x);\n\t\t_old_"+e+"="+e+";\n\t\t"+e+"=x\n\t\treturn changed;\n\t},\n\tchanged_"+e+": function(x) {\n\t\treturn x!=="+e+";\n\t}"});if(e.find(".didi-watcher").addBack(".didi-watcher").each(function(){var e=$(this).data("didi-field");e&&e.parent_page==i&&(n=n.concat(e["didi-functions"]))}),a.model_funcs&&(n=a.model_funcs.concat(n)),a.model_funcs=n,n.length){n="\nreturn {\n"+n.join(",\n")+"}";var s="";r.length&&(r="var "+r.map(function(e){return e+"='',_old_"+e+"=''"}).join(",")),t.js&&$.each(t.js,function(e,t){/^\s*function\(/.test(t)?s+="\n"+t.replace(/^s*function\s*(\([^)]*\))/m,"function "+e+"$1")+"\n":s+="var "+e+" = "+t+";\n"}),s+="\n"+r,t.js_functions&&(s+="\n\n"+t.js_functions+"\n\n"),a.model_src&&(s=a.model_src+s),s+=n,a.model_src=s,a.model=new Function(s)(),t.dd_init&&$.each(t.dd_init,function(e,t){a.model["set_"+e](t)}),e.on("update_watchers",function(t){a.updateWatchers({root:e})}).trigger("update_watchers")}},a.updateWatchers=function(t){function r(t,r,i){if(!r||!r["didi-model"])return!1;var n=!1;return $.each(r["didi-model"],function(s,o){if(0!=s.indexOf("on_")){var d=/\$\{(\d+)\}/g.capture(o),c="get_"+i+"_";d.forEach(function(i){var d=a.model[c+i];if(void 0!==d){var l=d(t),p="\\$\\{"+i+"\\}",u=o;o=new RegExp("^"+p+"$","g").test(o)?l:o.replace(new RegExp(p,"g"),l),o!==u&&(n=!0),r[s]=o,"text"==s&&t.text(o),"value"==s&&(r.precision&&e.isNumeric(o)&&(o=parseFloat(o).toFixed(r.precision)),t.val(o),Q(t,{update_watchers:!1}))}})}}),n}let i=t&&t.root||a.root,n=t&&t.invoker||void 0;var s=i.data("didi-field");if(!s)return;var o=s.id;let d=null;if(n){let e=n.data("didi-field");d=e&&e.id}i.find(".didi-watcher").addBack(".didi-watcher").each(function(){var e=$(this);if(e.is(n))return;var t=e.data("didi-field");if(!t||t.parent_page!=o)return;let a=t.peers;if(!a||a.includes(d)){var i=t.id||e.attr("for"),s=r(e,t,i),c=r(e,t.style,i),l=r(e,t.class,i);s&&K(e,t),(s||l)&&R(e,t),(s||c)&&S(e,t),s&&O(e,t),s&&j(e,t)}})}}})(didi);