(function(e){"use strict";e.render=function(t){var r=this;r.invoker=t.invoker;var i=r.types=t.types;r.id=t.id;r.page_id=t.id;r.options=t;r.sink=undefined;r.parent=t.parent;r.known={};r.root={};r.request=t.request;r.model={};r.model_src=t.model_src;r.model_funcs=t.model_funcs;var n=["type","types","template","action","attr","wrap","default"];var a=["left","right","width","top","bottom","height","line-height","max-height","max-width"];var s=function(e){return e.mutable||e.mutable===undefined||e.mutable!==false};var f=function(t){var n={};for(var a in t){var s=t[a];var f=r.mergeType({},i[s],undefined,s);n=e.merge(n,f)}return n};this.mergeType=function(t,n,a){if(t===null||t===undefined||i===undefined)return t;if(n===undefined)n=t.type;if(n===undefined&&t.html===undefined){if(!a)a=t.id;var s;if(a)s=a.replace(/_/g,"-");if(t.classes){n="control";if(i[t.classes])n=t.classes;else t.tag=t.classes;if(s)t.class=e.appendArray(t.class,s)}else if(t.templates){n="template";t.tag=t.templates;if(s)t.class=e.appendArray(t.class,s)}else if(t.tag)n="control"}if(n===undefined)return t;if(typeof n==="string")n=r.mergeType(i[n],undefined,n);else if($.isArray(n))n=f(n);else n=r.mergeType(n);var o=e.merge(n,t);delete o.type;return o};this.expandType=function(e){if($.isPlainObject(e))return r.mergeType(e);if(e.search(/\W/)>=0)return{html:e};return r.mergeType({type:e})};var o=function(e){for(var t in n){var r=n[t];if(e[r]!==undefined)return true}return false};var d=function(e,t,r){var i=r.immutable;for(var n in i){var a=i[n];if(t[a]!==undefined&&e[a]===undefined)e[a]=t[a]}};var l=function(t,r,i){if(!t)return e.merge(i,r);d(r,t,i);t=e.copy(t);e.deleteKeys(t,["type","styles","style"]);e.deleteKeys(t,a);return e.merge(i,t,r)};var u=function(t,r,i){if(!t.action&&r.action)t.action=r.action;if(r.attr)t.attr=e.merge(t.attr,r.attr);if(!t.template)t.template=r.template;if(r.default)t=e.merge(r.default,t);if(r.types)return l(i,t,r.types.shift());else if(!t.type&&r.type)return l(i,t,r.type);return e.merge(i,t)};var c=function(e,t){var r=e.length;while(r--){var i=e[r];if(t.indexOf(i.id)>=0||i.id=="pop")e.splice(r,1)}};var p=function(t,r){for(var i in r){var n=r[i];var a=n.push;delete n.push;var s=t.indexOf(n);n=e.copy(n);t.splice(s,1);if(a==="first")t.unshift(n);else if(a==="last")t.push(n);else if(a=="merge"){s=e.firstIndexOfKey(t,"id",n.id);t[s]=e.merge(t[s],n)}else t.splice(e.firstIndexOfKey(t,"id",a),0,n)}};var v=function(e){var t=[];var r=[];for(var i in e){var n=e[i];if($.isArray(n))continue;if(n.id=="pop")r.push(n.name);else if(n.push)t.push(n);e[i]=n}c(e,r);p(e,t)};var g=function(t){for(var r in t){var i=t[r];if($.isArray(i)&&i.length==1)i=i[0];if(typeof i=="string"){try{var a=JSON.parse(i);i=a}catch(t){i=e.toObject(i)}}if(!$.isPlainObject(i))continue;var s=i.id;if(s===undefined){var f=e.firstElement(i);s=f[0];if(n.indexOf(s)>=0)continue;i=f[1];if(typeof i=="string")i={name:i};i=$.extend({},i)}if(typeof i==="string")i={name:i};i.id=s;t[r]=i}};var h=function(e,t){for(var r=0;r<t.length;++r){var i=t[r];if(!$.isPlainObject(i)||i.id!=="merge")continue;var n=e[i.name];if(!n)continue;t.splice(r,1);g(n);n.forEach((function(e,i){t.splice(r+i,0,e)}))}};this.expandFields=function(t,i,n,a){if(!a)a={template:"$field"};var f=t.path?t.path+"/"+i:i;g(n);v(n);h(t,n);var o;var d=t.sow;var l=[];var c=0;n.forEach(((o,p)=>{var v;var g;var h;l.push(p);if($.isPlainObject(o)){if(H(a,o,t))return;v=o.id;if(v=="query"){o.defaults=e.copy(a)}if(v[0]=="$"){v=v.substr(1);o=e.merge(t[v],o)}v=r.expandValue(t,v);if(d&&d.indexOf(v)>=0)o=e.merge(t[v],o);X(o);var m=e.copy(r.types[v]);var x=e.merge(m,o);o.id=v;if(s(x))o=u(o,a,m);else o=x}else if($.isArray(o)){g=o;v=o[0];o=e.copy(a);o.array=g}else{console.log("Unhandled item",o,t)}o.id=v;if(f&&!o.path)o.path=f+"/"+v;var h=o.template;if(h=="none"||h=="$field")delete o.template;else if(typeof h=="string"){var _={};H(_,{template:h},t);o.template=_.template}if(a.wrap){o.wrap=a.wrap;o.wrap.id=i;o.wrap=this.initField(o.wrap,t);delete a.wrap}o=$.extend({index:c,number:c+1},o);++c;o=this.initField(o,t);if(o.template)y(o);n[p]=o;l.pop()}));for(var p in l){n.splice(l[p]-p,1)}};var m=function(e){return e!==undefined&&e!=="none"&&e!=="$field"};var y=function(t){var i=t.template;var n=e.copy(r.mergeType(t));if(typeof i==="string"){i={html:i}}else{i=r.mergeType(e.copy(i));e.deleteKeys(n,["type","attr","action","class","tag","html","style","styles","create","classes","template","templates","text","templated","didi-functions"]);e.deleteKeys(n,a);if(!("attr"in i))i.attr={};i.attr["for"]=t.id}for(var s in n){if(s.indexOf("on_")==0)delete n[s]}t.template=r.initField(e.merge(i,n));t.template.id=""};this.expandFunction=function(e,t){var r=/(copy|css)\s*\((.+)\)/.exec(e);if(!r||r.length<1)return e;var i=r[2];if(r[1]==="copy")i="#"+i+" #"+t+",[name="+i+"] #"+t;return $(i).value()};var x=function(e){if(!e||$.isPlainObject(e))return[];if(!$.isArray(e))e=[e];return e};var _=function(t,r){return x(r).map((function(r){var i=e.getMatches(r,/\$(\w+)/g);for(var n in i){var a=i[n];var s=t[a];if(s===undefined||typeof s!=="string")continue;r=r.replace("$"+a,s)}return r}))};this.expandValue=function(e,t){$.each(e,(function(r,i){if($.isNumeric(r)||typeof i!=="string"||typeof t!=="string")return;t=t.replace(new RegExp("\\$"+r+"([^w]|\b|$)","g"),i+"$1");e[r]=i;if(t.indexOf("$")<0)return}));return t};this.expandValues=function(e,t,i){if(!e)return e;if(t===undefined)t=e.id;var n;var a=0;if(!i)i=[];var s=$.isArray(e.constants)?e.constants:[];i=i.concat(s);do{n=false;for(var f in e){var o=e[f];if($.isNumeric(o))continue;if($.isArray(o))e[f]=_(e,o);if(typeof o!=="string"||o.indexOf("$")<0||i.indexOf(f)>=0)continue;var d=o=o.replace("$id",t);e[f]=o=r.expandValue(e,o,t);n=d!==o}}while(n);return e};this.expandArray=function(t){if(t.expand_data){t[t.expand_data]=t[t.expand_data].concat(t.array);delete t.array;return}$.each(t,(function(r,i){var n=e.getMatches(i,/\$(\d+)/g);for(var a in n){var s=parseInt(n[a]);i=i.replace(new RegExp("\\$"+s+"([^d]|\b|$)","g"),t.array[s-1]+"$1")}t[r]=i}))};this.parentSow=function(t,r){if(!t||!t.sow)return r;for(var i in t.sow){var n=t.sow[i];var a={};a[n]=t[n];r=e.merge(a,r)}return r};var w=function(t,r){if(!t)return;if(!r.parent_id&&t.id)r.parent_id=t.id;if(!r.parent_name&&t.name)r.parent_name=t.name;for(var i in r.derive){var n=r.derive[i];var a=r[n];if(a===undefined)r[n]=t[n];else if($.isPlainObject(a)||$.isArray(a))r[n]=e.merge(t[n],a);else if(typeof a==="string"&&a[0]==="$")r[n]=t[a.substr(1)]}delete r.derive};let b=function(t){let r=t.upgrade;if(!r)return t;e.each(r,((r,i)=>{let n=t[i];if(n===undefined)return;n=e.copy(n);e.each(r,((r,a)=>{let s=new RegExp(a);if(!e.isIterable(n)){if(s.test(n))t[i]+=" "+r}else if(e.some(n,((e,t)=>s.test(e)||s.test(t)))){t[i]=e.extend(t[i],r)}}))}));delete t.upgrade;return t};this.initField=function(t,r){t.page_id=this.page_id;if(t.template&&t.template.subject){t=e.merge(t.template.subject,t);if(!t.template.tag)delete t.template}w(r,t);t=this.parentSow(r,t);t=this.mergeType(t);var i=t.id;if(t.array&&t.array.length>1&&t.name===undefined)t.name=t.array[1];if(i&&t.name===undefined)t.name=e.toTitleCase(i.replace(/[_\/]/g," "));if(t.array)this.expandArray(t);else t=B(t);var n=["template","attr","text","html"];this.expandValues(t,t.id,n);if(t.template&&t.template.subject){w(t.template,t);this.expandValues(t,t.id,n)}if(t.class!==undefined){if(!e.isArray(t.class))t.class=[t.class];t.class=t.class.reduce(((e,t)=>typeof t==="string"?e.concat(t.split(" ")):e),[])}b(t);return t};var k=function(e){return["table","thead","th","tbody","tr","td"].indexOf(e)>=0};var j=function(t,r){if(!r.jquery)return;e.replaceVars(r,r.params);t.call(r.jquery,r.params)};var O=function(t,r){if(r.template)return;e.toIntValue(r,"show");e.toIntValue(r,"hide");if(r.hide||r.show===false||r.show===0)t.hide();else if(r.show)t.show()};var C=function(t,r){if(e.toIntValue(r,"disabled")&&r);t.prop("disabled",r.disabled)};this.render=function(e,t){var i=e[t]=r.initField(e[t],e);r.root_field=i;var n=r.root=r.create(e,t,false);r.initModel(n,i);return n};var P=function(e,t){var r=t.responsive;if(!r)return;var i={small:"screen and (max-width:600px)",medium:"screen and (min-width:601px) and (max-width:992px)",large:"screen and (min-width:993px)"};for(var n in i){var a=r[n];if(!a)continue;enquire.register(i[n],{match:function(){e.addClass(a.join(" "))},unmatch:function(){e.removeClass(a.join(" "))}})}};var A=function(e,t){if(!$.isPlainObject(t))return e.setClass(t);O(e,t);C(e,t);P(e,t);S(e,t);M(e,t);z(e,t)};this.create=function(n,a,s,f){var o=n;if(typeof a=="string"||$.isNumeric(a)){o=n[a];if(!o)o=i[a]}else if($.isPlainObject(a))o=a;if(s===undefined||s)o=this.initField(o,n);if(o.parent_page===undefined)o.parent_page=r.id;if(o.sub_page){var d=$("<div>loading...</div>");this.createSubPage(n[a],d);return d}var l=o.id;if(o.html===undefined)return null;o.text=this.expandValue(o,o.text);o.html=this.expandValue(o,o.html);o.html=o.html.trim().replace(/\$tag(\W)/,o.tag+"$1");var u=k(o.tag);var c=u?$("<"+o.tag+">"):$(o.html);if(o.is_body)c=$("body").append(c.html());if(this.sink===undefined)this.sink=c;var p=["id","create","css","script","name","desc","data"];ie(c,o);if(o.key===undefined)o.key=t.key;var v=$.extend({},this.types,o);var g=e.getMatches(o.html,/\$(\w+)/g);var h=0;for(var m=0;m<g.length;++m){var y=g[m];var x=v[y];if(x===undefined)continue;if(typeof x==="string"&&x.search(/\W/)<0&&p.indexOf(y)<0){x=v[x]||x}if($.isArray(x)){if(this.types[y]!==undefined)x=$.merge($.merge([],this.types[y]),x);this.expandFields(o,y,x);h+=this.createItems(c,o,y,x);continue}if(!$.isPlainObject(x)){c.replace(new RegExp("\\$"+y+"([^w]|\b|$)?","g"),x+"$1");this.known[y]=x;continue}if(!x.path)x.path=o.path+"/"+y;if(x.id===undefined)x.id=y;x.parent_page=o.parent_page;var _=this.create(o,y,true);if(u)c.append(_);if(o.html=="$"+y)c.html("").append(_);else this.replace(c,_,y)}if(c.attr("id")==="")c.removeAttr("id");c.data("didi-field",o);A(c,o);if(o.parent&&f){A(f,o.parent)}j(c,o);if("didi-functions"in o)c.addClass("didi-watcher");o["mkn-object"]=c;if($.isPlainObject(o.position))c.position(o.position);R(c,o).then((function(){if(h)r.setValues(c,o);K(c,o);c.triggerHandler("created",[o])}));if(typeof a==="string"||$.isNumeric(a))n[a]=o;return c};this.createSubPage=function(e,r,i){if(r==undefined)r=$("<span>").text("loading...");delete e.sub_page;delete e.appendChild;e.path=e.url?e.url:e.id;return $.showPage($.extend({request:t.request},e),r).done((function(e,t,n){z(e,n);M(e,n);P(e,n);r.trigger("dying");r.replaceWith(e);if(!i)return;var a=i.regexCapture(/(\.[\w-][\w-\.]*)$/g);if(a.length)e.addClass(a[0].replace("."," "))}))};this.createItems=function(e,t,r,i,n){var a=false;var s;if(r!==undefined&&t.html.trim()!=="$"+r&&!k(t.tag))s=new RegExp("(\\$"+r+")");var f="_new_"+r;var o='<div id="'+f+'"></div>';var d;var l=0;for(var u in i){var c=i[u];var p=c.id;if(p=="query"){if(a)continue;a=true;this.loadData(e,t,r,c.defaults);continue}++l;if(s)e.replace(s,o+"$1");var v;var g=this.create(i,u);if(c.template&&(v=this.create(c,"template"))){if(k(c.template.tag))v.append(g);else this.replace(v,g,p,"field");if(c.parent)A(v,c.parent)}else{v=g;delete c.template}if(d)d.append(v);else if(c.wrap){d=this.create(c,"wrap");d.html("");e.find("#"+f).replaceWith(d);d.append(v);delete c.wrap}else if(s)e.find("#"+f).replaceWith(v);else e.append(v)}if(!a&&s)e.replace(s,"");return l};this.replace=function(e,t,r,i){r=r||t.attr("id");i=i||r;var n="__new__"+r.replace(/[^\w]/g,"_");var a="<div id="+n+"></div>";e.replace("\\$"+i,a);e.find("#"+n).replaceWith(t);return t};this.loadData=function(e,t,i,n){this.loading++;e.on("loaded",(function(t,a,s){if(--r.loading===0)r.parent.trigger("loaded",s);if(s===undefined||s===null){console.log("No page data result for object: ",r.object," field ",a.id);return}if(n.attr===undefined)n.attr={};n.attr.loaded="";if(e.find("[loaded]").exists()){e.find("[loaded]").replaceWith("$"+i)}r.expandFields(a,i,s,n);r.createItems(e,a,i,s,n);if(r.loading===0)r.parent.trigger("loaded",[a,s])}));if(t.autoload||t.autoload===undefined){$.json("/",V("data",t.path+"/"+i,$.extend({},t.params,{key:t.key})),(function(i){r.respond(i,e);e.trigger("loaded",[t,i.data])}))}e.on("reload",(function(a,s){t.autoload=true;t.params=s;r.loadData(e,t,i,n);if(t.values)r.loadValues(e,t)}))};var V=function(e,i,n){if(!i)i=r.path;return{data:$.extend({},t.request,{key:t.key},n,{action:e,path:i})}};var F=function(e){};function I(t,r){var i={every:"Interval",after:"Timeout"};for(var n in i){if(!(n in r))continue;e.replaceVars(r,r[n],{recurse:true,sourceFirst:true});var a=[r[n].slice(1)];var s=window["set"+i[n]]((function(){Q(undefined,t,r,a)}),r[n][0]);t.data(n,s)}t.on("remove",(function(){for(var e in i){if(!(e in r))continue;window["clear"+i[e]](t.data(e))}}))}var T=function(e,t){if(!t.listen)return;var r=$.isArray(t.listen)?t.listen:[t.listen];$.each(r,(function(r,i){e.on(i,(function(){e.trigger(i+"_"+t.id)}))}))};var q=function(t,i){var n={};if(i.action)n["click"]=[i];var a=i.id;T(t,i);$.each(i,(function(e,r){if(e.indexOf("on_")!=0)return;var i=e.substr(3);if(!(i in n))n[i]=[];if($.isArray(r))n[i]=n[i].concat(r);else n[i].push(r);if(!t.hasClass("didi-listener"))t.addClass("didi-listener")}));if($.isEmptyObject(n))return;$.each(n,(function(n,s){$.each(s,(function(s,f){if($.isPlainObject(f)&&!f.path)f.path=i.path+"/on_"+n;var o=t;if(t.is("body")&&["scroll","resize"].indexOf(n)>=0)o=$(window);var d="on_"+n.replace(/\W/g,"_");var l=n.split("@");var u=l[0];var c=l.length>1?l[1]:null;o.on(u,c,(function(n){if(t.hasClass("disabled"))return;if(u=="click"&&t.prop("tagName").toLowerCase()=="a"){n.preventDefault();if(i.url===undefined)i.url=t.attr("href")}if($.isPlainObject(f)){var s=Array.prototype.slice.call(arguments,1);f.params=e.merge(f.params,s);e.replaceVars(f,f.params);Q(n,t,f)}else if("didi-model"in i&&d in i["didi-model"]){var o=r.model[d+"_"+a];if(o)o.apply(t,arguments);r.updateWatchers()}}))}))}))};var E=function(e,t){var r=x(t.trap);$.each(r,(function(t,r){e.on(r,(function(e){e.stopPropagation()}))}))};var W=function(e,t){var r=x(t.triggers);if(!r.length)return;e.on("click",(function(t){if(e.is($(t.target)))$.each(r,(function(t,r){e.trigger(r)}))}))};var D=function(e,t){var r=x(t.toggles);var i,n,a="click";switch(r.length){case 0:return;case 1:i=r[0];break;case 2:i=r[0];n=r[1];break;default:i=r[0];n=r[1];a=r[3]}e.on(a,(function(){if(i==n)e.toggleClass(i);else if(e.hasClass(i))e.removeClass(i).addClass(n);else e.removeClass(n).addClass(i)}))};var N=function(e,t){var r=t.events;if(!r)return;e.on(Object.keys(r).join(" "),(function(t){e.setClass(r[t.type])}))};var K=function(e,t){D(e,t);N(e,t);if("attr"in t&&t.attr.for==t.id)return;W(e,t);E(e,t);I(e,t);q(e,t);if(typeof t.enter=="string"){e.keypress((function(r){if(r.keyCode===13)e.find(t.enter).click()}))}t.page_id=r.page_id;e.on("reload",(function(r,i){t.params=i;ee(e,t)})).on("server_response",(function(e,t){e.stopImmediatePropagation();r.respond(t)}));F(e);e.on("post",(function(e,r){t=$.extend({},t,{action:"post",params:[r]});Q(e,$(this),t)}));var i=e.prop("tagName");if(!i||["input","select","textarea"].indexOf(i.toLowerCase())<0)return;var n=re(t);e.on("keyup input cut paste change",(function(){var e=r.model["set_"+n];if(!e||e($(this).value()))r.updateWatchers()}))};var R=function(e,t){return $.when(J("css",t),J("script",t)).then((function(i,n){if(t.create)e.customCreate($.extend({render:r},t))}))};var S=function(t,r){e.replaceVars(r,r.attr,{sourceFirst:true,recurse:true});var i=r.attr;if(t.attr("id")==="")t.removeAttr("id");if(!i)return;if(typeof i==="string"){t.attr(i,"")}else $.each(i,(function(i,n){if(r.array){var a=e.getMatches(n,/\$(\d+)/g);if(a.length)n=r.array[a[0]-1]}var s=e.getMatches(n,/\$(\w+)/g);for(var f in s){var o=s[f];var d=r[o];if(d===undefined||typeof d!=="string")continue;n=n.replace("$"+o,d)}t.attr(i,n)}));if(t.attr("id")==="")t.removeAttr("id")};var M=function(e,t){e.setClass(_(t,t.class))};var z=function(t,i){var n=i.immutable;var s=function(){if(typeof d=="string")d=r.mergeType({},d.split(/[\s,]+/));for(var t in d){var i=r.mergeType({},d[t]);e.deleteKeys(i,n);$.extend(o,i)}};var f=function(){for(var e in a){var t=a[e];if(n&&n.indexOf(t)>=0)continue;var r=i[t];if(r!==undefined&&r[0]!=="$")o[t]=r}};var o=i.style;if(!o)o={};var d=i.styles;if(d)s();e.replaceVars(i,o,{sourceFirst:true,recurse:true});e.replaceVars(o,o,{sourceFirst:true,recurse:true});f();t.css(o)};var B=function(t){var r=[];$.each(t,(function(e,t){if(typeof t!=="string")return;if(t.match(/^\$\d+$/))r.push(e)}));e.deleteKeys(t,r);return t};var L=function(e){var t=e.subject;for(var r in t){}};var U=function(t,r,i){var n=t[r];if($.isPlainObject(n))i=e.merge(n,i);else if(typeof i=="string")i.type=n;return i};var H=function(t,i,a){if(e.size(i)!=1)return false;var s=a.sow;var f=false;for(var o in n){var d=n[o];var l=i[d];if(l===undefined)continue;if(l[0]=="$")l=a[l.substring(1)];if(l===undefined)continue;if(s&&s.indexOf(l)>=0)l=e.merge(a[l],t[d]);if(d==="template"&&l==="none")l="$field";else if(d==="wrap"&&$.isPlainObject(l))l=$.extend({},{tag:"div"},l);else if(d==="type"||d==="template"||d==="wrap"){if(l===undefined){console.log("undefined value",d,i)}l=r.expandType(l)}else if(d==="types"){var u=[];for(var o in l){u.push(r.expandType(l[o]))}l=u}if(d=="template"&&$.isPlainObject(i[d])&&i[d].type===undefined){l=U(t,d,r.initField(l));e.replaceVars(l,l.subject,{recurse:true})}t[d]=l;f=true}X(t);return f};var J=function(e,t){var r=t[e];if(typeof r==="string")r=r.split(",");if(r===undefined||r===null||r.length==0)return $.when();return $.when.apply($,$.map(r,(function(t){return $.loadLink(t,e)})))};var X=function(e){var t=e.attr;if(t===undefined||$.isPlainObject(t))return;var r={};r[t]=t;e.attr=r;return e};var G=function(i){if(!$.isPlainObject(i))i={url:i};e.replaceVars(i,i);var n=i.url;if((!n||i.query)&&i.target==="_blank"){n="/?action=action";i=$.extend({key:t.key},i);var a=["action","desc","html","id","name","page_id","query","selector","tag","target","text","type","template"];for(var s in i){var f=i[s];if($.isPlainObject(f)||$.isArray(f)||a.indexOf(s)>=0)continue;n+="&"+s+"="+encodeURIComponent(i[s])}}if(!n)return;if(i.target==="_blank")window.open(n,i.target);else if(i.target){$.closeDialog(r.sink);r.createSubPage({url:n,key:i.key},$(i.target),i.target)}else document.location=n};var Q=function(e,t,i,n){i.page_id=i.page_id||t.closest(".page").attr("id");var a=function(e){var r=e&&$.isPlainObject(e._responses)&&"errors"in e._responses?"error":"success";t.trigger("post_"+r,[e])};var s=function(n){var s=[];if($.isArray(n)){s=n.slice(1);n=n[0]}switch(n){case"page":$.showPage(i);return;case"dialog":$.showDialog(i.url,$.extend({key:i.key},s[0]));return;case"close_dialog":$.closeDialog(t);break;case"redirect":G(i);break;case"post":var f=i.url?i.url:i.path;if(!i.params)i.params=[];s=V("action",f,$.extend({key:i.key},s[0],i.params[0]));if($.isArray(i.params))s=$.extend({},s,i.params[0]);var o=i.selector;if(o!==undefined){o=o.replace(/(^|[^\w]+)page([^\w]+)/,"$1"+i.page_id+"$2");s=$.extend(s,{invoker:t,event:e,async:true,post_prefix:i.post_prefix});r.sink.find(".error").remove();r.sink.find(".in-error").unsetClass("in-error").trigger("clear-error");t.trigger("posting",[s]);$(o).json("/",s,(function(i){a(i);r.respond(i,t,e)}));break}r.sink.find(".error").remove();r.sink.find(".in-error").removeClass("in-error").trigger("clear-error");t.trigger("posting",[s]);t.trigger("posting");$.json("/",s,(function(e){a(e);r.respond(e,t)}));break;case"trigger":te(i,t);break;default:if(n&&n[0]==".")t[n.substring(1)].apply(t,s)}};var f=function(){if(n===undefined)n=i.action;if($.isArray(n))n.forEach(s);else s(n)};if(!i.confirmation||n)f();else $.showDialog("/confirm_dialog").done((function(e){if(typeof i.confirmation=="string")e.find("#message").text(i.confirmation);e.find(".action").click((function(){$.closeDialog(e);if($(this).attr("action")==="yes")f()}))}))};var Y=function(e,t){if(e=="alert"){alert(t);return}var i=r.sink.find("#"+e+",[name='"+e+"']");var n;if(i.hasClass("error-sink")){n=i}else{var a=i.parents(".error-sink");if(!a.exists())a=i.parents("[for='"+e+"']");n=a.exists()?a.eq(0):i}i.trigger("errors",[t]);n.addClass("in-error").attr("error-message",t);if(n.hasClass("no-error-box")||i.hasClass("no-error-box"))return;var s=$("<div class=error>"+t+"</div>");n.after(s);var f=parseInt(n.css("z-index"));s.css("z-index",f+1);s.fadeIn("slow").click((function(){$(this).fadeOut("slow")}))};var Z=function(e,t){for(var r in e){Y(r,e[r])}if(t)t.stopImmediatePropagation()};this.respond=function(t,i,n){if(!t)return;e.removeXSS(t);var a=t._responses;delete t._responses;if(!$.isPlainObject(a))return this;var s=r.sink;if(i){s=i.parents("#"+r.page_id).eq(0);if(!s.exists())s=r.sink}else i=s;var f=function(e,t){switch(e){case"alert":alert(t);break;case"show_dialog":$.showDialog(t,a.options);break;case"close_dialog":$.closeDialog(s,t);break;case"redirect":G(t);break;case"update":s.setChildren(t,true);break;case"trigger":te(t,s);break;case"error":Y(t);break;case"errors":Z(t);break}};for(var o in a){var d=a[o];if(!$.isArray(d))f(o,d);else for(var l in d)f(o,d[l])}};this.setValues=function(t,r){var i;for(var n in r.values){var a=r.values[n];var s=$.isNumeric(n);if(s&&!$.isPlainObject(a))continue;var f=n,o=a;if(s){var d=e.firstElement(a);f=d[0];a=d[1]}var l=t.find(e.selector.idName(f));if(l.exists()){l.value(o);continue}if(f==="query")i=true}if(i){t.on("load_values",(function(e,r){ee(t,r)}));if(t.auto_load===undefined||t.auto_load)t.trigger("load_values",[r])}};var ee=function(e,t){var i=$.extend({key:t.key},t.params);$.json("/",V("values",t.path,i),(function(t){if(!t)return;e.trigger("loaded_values",[t]);if($.isPlainObject(t))e.setChildren(t,true);else for(var i in t){e.setChildren(t[i],true)}r.updateWatchers();r.respond(t)}))};var te=function(e,t){if(!e.event)e.event=e.id;var i;var n=e.event;var a;if($.isPlainObject(n)){i=n.sink;r.expandValues(n.parameters,e.id);a=n.parameters;n=n.name}else{i=e.sink;a=e.params;if(a!==undefined&&!$.isArray(a))a=[a];if(n==="show"||n=="show_hide")n=".toggle";if(n=="toggle"||n==".toggle"&&a!==undefined)a=[parseInt(a[0])===1||a[0]===true]}if(i){var s=i;i=$(i.replace(/(^|[^\w]+)page([^\w]*)/,"$1"+r.id+"$2"));if(!i.exists())i=window.parent.$(s)}else if(t)i=t;else i=$(".didi-listener");if(n[0]==="."){i[n.substring(1)].apply(i,a);return}i.trigger(n,a)};var re=function(e){return e.attr&&e.attr.type=="radio"?e.attr.name:e.id};var ie=function(e,t){var r=[];var i=0;var n=t.id;function a(e,t,a){a=a.trim();var s;if(/^~|\s*function\s*\([^)]*\)/gm.test(a))s=[a];else s=a.regexCapture(/(`[^`]+`)/g);var f=false;t=t.replace(/\W/g,"_");s.forEach((function(e,s){if(!e)return;var o;var d="\n\t}";var l=/\breturn\s/gm.test(e)?"":"\t\treturn ";if(t.indexOf("on_")!=0)o="\tget_"+n+"_"+i+": function(obj) {\n"+l;else if(!/^[~`]?\s*function\s*\(/gm.test(e))o="\t"+t+"_"+n+": function(event) {\n";else{o="\t"+t+"_"+n+": ";d=""}o+=e.replace(/^~|`/g,"")+d;r.push(o);a=a.replace(e,"${"+i+"}");f=true;++i}));if(f)e["didi-model"][t]=a}function s(t,r){for(var i in r){var n=r[i]["script"];if(!n)return;if(/^[~`]?\s*function\s*\(/gm.test(n))n="function(event) { "+n+" }";var a=e;if(e.is("body")&&t=="scroll")a=$(window);a.on(t,$.proxy(Function(n),e))}}function f(e,t){if(t=="html")return;var r=e[t];if(typeof r=="string")a(e,t,r);else if(t.indexOf("on_")==0&&$.isArray(r))s(t.substr(3),r)}function o(e){if(!e)return;e["didi-model"]={};for(var t in e){f(e,t)}}o(t);o(t.style);o(t.class);if(r.length)t["didi-functions"]=r};this.initModel=function(e,t){var i=[];var n=e.id;if(t.dd_init)$.each(t.dd_init,(function(e,t){i.push(e)}));e.find("input,select,textarea").addBack("input,select,textarea").each((function(){var e=$(this).data("didi-field");if(!e||e.parent_page!=n)return;var t=re(e);if(i.indexOf(t)<0)i.push(t)}));var a=i.map((function(e){return"\tset_"+e+": function(x) {\n\t\tvar changed = ("+e+" !== x);\n\t\t_old_"+e+"="+e+";\n\t\t"+e+"=x\n\t\treturn changed;\n\t},"+"\n\tchanged_"+e+": function(x) {\n\t\treturn x!=="+e+";\n\t}"}));e.find(".didi-watcher").addBack(".didi-watcher").each((function(){var e=$(this).data("didi-field");if(!e||e.parent_page!=n)return;a=a.concat(e["didi-functions"])}));if(r.model_funcs)a=r.model_funcs.concat(a);r.model_funcs=a;if(!a.length)return;a="\nreturn {\n"+a.join(",\n")+"}";var s="";if(i.length)i="var "+i.map((function(e){return e+"='',_old_"+e+"=''"})).join(",");if(t.js){$.each(t.js,(function(e,t){if(/^\s*function\(/.test(t))s+="\n"+t.replace(/^s*function\s*(\([^)]*\))/m,"function "+e+"$1")+"\n";else s+="var "+e+" = "+t+";\n"}))}s+="\n"+i;if(t.js_functions)s+="\n\n"+t.js_functions+"\n\n";if(r.model_src)s=r.model_src+s;r.model_src=s;s+=a;r.model=new Function(s)();if(t.dd_init)$.each(t.dd_init,(function(e,t){r.model["set_"+e](t)}));r.updateWatchers(e)};r.updateWatchers=function(e){if(!e)e=r.root;function t(e,t,i){if(!t||!t["didi-model"])return false;var n=false;$.each(t["didi-model"],(function(a,s){if(a.indexOf("on_")==0)return;var f=s.regexCapture(/\$\{(\d+)\}/g);var o="get_"+i+"_";f.forEach((function(i){var f=r.model[o+i];if(f===undefined)return;var d=f(e);var l="\\$\\{"+i+"\\}";var u=s;if(new RegExp("^"+l+"$","g").test(s))s=d;else s=s.replace(new RegExp(l,"g"),d);if(s!==u)n=true;t[a]=s;if(a=="text")e.text(s);if(a=="value")e.val(s)}))}));return n}var i=e.data("didi-field");if(!i)return;var n=i.id;e.find(".didi-watcher").addBack(".didi-watcher").each((function(){var e=$(this);var r=e.data("didi-field");if(!r||r.parent_page!=n)return;if(!r)return;var i=r.id||e.attr("for");var a=t(e,r,i);var s=t(e,r.style,i);var f=t(e,r.class,i);if(a)S(e,r);if(a||f)M(e,r);if(a||s)z(e,r);if(a)O(e,r);if(a)C(e,r)}))}}})(didi);