(function(e){"use strict";e.render=function(t){function a(t,a){var r={every:"Interval",after:"Timeout"};for(var i in r)if(i in a){e.replaceVars(a,a[i],{recurse:!0,sourceFirst:!0});var n=[a[i].slice(1)],s=window["set"+r[i]](function(){J(void 0,t,a,n)},a[i][0]);t.data(i,s)}t.on("remove",function(){for(var e in r)e in a&&window["clear"+r[e]](t.data(e))})}var r=this;r.invoker=t.invoker;var i=r.types=t.types;r.id=t.id,r.page_id=t.id,r.options=t,r.sink=void 0,r.parent=t.parent,r.known={},r.root={},r.request=t.request,r.model={},r.model_src=t.model_src,r.model_funcs=t.model_funcs;var n=["type","types","template","action","attr","wrap","default"],s=["left","right","width","top","bottom","height","line-height","max-height","max-width"],o=function(e){return e.mutable||void 0===e.mutable||!1!==e.mutable},d=function(t){var a={};for(var n in t){var s=t[n],o=r.mergeType({},i[s],void 0,s);a=e.merge(a,o)}return a};this.mergeType=function(t,a,n){if(null==t||void 0===i)return t;var s;(void 0===a&&(a=t.type),void 0===a&&void 0===t.html)&&(n||(n=t.id),"string"==typeof n&&(s=n.replace(/_/g,"-")),t.classes?(a="control",i[t.classes]?a=t.classes:t.tag=t.classes,s&&(t.class=e.appendArray(t.class,s))):t.templates?(a="template",t.tag=t.templates,s&&(t.class=e.appendArray(t.class,s))):t.tag&&(a="control"));if(void 0===a)return t;a="string"==typeof a?r.mergeType(i[a],void 0,a):$.isArray(a)?d(a):r.mergeType(a);var o=e.merge(a,t);return delete o.type,o},this.expandType=function(e){return $.isPlainObject(e)?r.mergeType(e):e.search(/\W/)>=0?{html:e}:r.mergeType({type:e})};var l=function(e,t,a){var r=a.immutable;for(var i in r){var n=r[i];void 0!==t[n]&&void 0===e[n]&&(e[n]=t[n])}},c=function(t,a,r){return t?(l(a,t,r),t=e.copy(t),e.deleteKeys(t,["type","styles","style"]),e.deleteKeys(t,s),e.merge({},r,t,a)):e.merge({},r,a)},p=function(t,a,r){return!t.action&&a.action&&(t.action=a.action),a.attr&&(t.attr=e.merge({},t.attr,a.attr)),t.template||(t.template=a.template),a.default&&(t=e.merge({},a.default,t)),a.types?c(r,t,a.types.shift()):!t.type&&a.type?c(r,t,a.type):e.merge({},r,t)},u=function(e,t){for(var a=e.length;a--;){var r=e[a];(t.indexOf(r.id)>=0||"pop"==r.id)&&e.splice(a,1)}},f=function(t,a){for(var r in a){var i=a[r],n=i.push;delete i.push;var s=t.indexOf(i);i=e.copy(i),t.splice(s,1),"first"===n?t.unshift(i):"last"===n?t.push(i):"merge"==n?(s=e.firstIndexOfKey(t,"id",i.id),t[s]=e.merge({},t[s],i)):t.splice(e.firstIndexOfKey(t,"id",n),0,i)}},v=function(e){var t=[],a=[];for(var r in e){var i=e[r];$.isArray(i)||("pop"==i.id?a.push(i.name):i.push&&t.push(i),e[r]=i)}u(e,a),f(e,t)},g=function(t){for(var a in t){var r=t[a];if($.isArray(r)&&1==r.length&&(r=r[0]),"string"==typeof r)try{var i=JSON.parse(r);r=i}catch(t){r=e.toObject(r)}if($.isPlainObject(r)){var s=r.id;if(void 0===s){var o=e.firstElement(r);if(s=o[0],n.indexOf(s)>=0)continue;r=o[1],"string"==typeof r&&(r={name:r}),r=$.extend({},r)}"string"==typeof r&&(r={name:r}),r.id=s,t[a]=r}}},h=function(e,t){for(var a=0;a<t.length;++a){var r=t[a];if($.isPlainObject(r)&&"merge"===r.id){var i=e[r.name];i&&(t.splice(a,1),g(i),i.forEach(function(e,r){t.splice(a+r,0,e)}))}}};this.expandFields=function(t,a,i,n){n||(n={template:"$field"});let s=t.path?t.path+"/"+a:a;g(i),v(i),h(t,i);let d=t.sow,l=[],c=0;for(var u in i.forEach((u,f)=>{let v,g;if(l.push(f),$.isPlainObject(u)){if(B(n,u,t))return;v=u.id,"query"==v&&(u.defaults=e.copy(n)),"$"==v[0]&&(v=v.substr(1),u=e.merge({},t[v],u)),v=r.expandValue(t,v),d&&d.indexOf(v)>=0&&(u=e.merge({},t[v],u)),U(u);let a=e.copy(r.types[v]),i=a?e.merge({},a,u):u;u.id=v,o(i)?u=p(u,n,a):i&&(u=i)}else $.isArray(u)?(g=u,v=u[0],u=e.copy(n),u.array=g):console.log("Unhandled item",u,t);u.id=v,s&&!u.path&&(u.path=s+"/"+v);let h=u.template;if("none"==h||"$field"==h)delete u.template;else if("string"==typeof h){var y={};B(y,{template:h},t),u.template=y.template}n.wrap&&(u.wrap=n.wrap,u.wrap.id=a,u.wrap=this.initField(u.wrap,t),delete n.wrap),u=$.extend({index:c,number:c+1},u),++c,u=this.initField(u,t),u.template&&m(u),i[f]=u,l.pop()}),l)i.splice(l[u]-u,1)};var m=function(t){var a=t.template,i=e.copy(r.mergeType(t));for(var n in"string"==typeof a?a={html:a}:(a=r.mergeType(e.copy(a)),e.deleteKeys(i,["type","attr","action","class","tag","html","style","styles","create","classes","template","templates","text","templated","didi-functions"]),e.deleteKeys(i,s),"attr"in a||(a.attr={}),a.attr.for=t.id),i)0==n.indexOf("on_")&&delete i[n];t.template=r.initField(e.merge({},a,i)),t.template.id=""};this.expandFunction=function(e,t){var a=/(copy|css)\s*\((.+)\)/.exec(e);if(!a||a.length<1)return e;var r=a[2];return"copy"===a[1]&&(r="#"+r+" #"+t+",[name="+r+"] #"+t),$(r).value()};var y=function(e){return!e||$.isPlainObject(e)?[]:($.isArray(e)||(e=[e]),e)},x=function(t,a){return y(a).map(function(a){var r=e.getMatches(a,/\$(\w+)/g);for(var i in r){var n=r[i],s=t[n];void 0!==s&&"string"==typeof s&&(a=a.replace("$"+n,s))}return a})};this.expandValue=function(e,t){return $.each(e,function(a,r){$.isNumeric(a)||"string"!=typeof r||"string"!=typeof t||(t=t.replace(new RegExp("\\$"+a+"([^w]|\b|$)","g"),r+"$1"),e[a]=r,t.indexOf("$"))}),t},this.expandValues=function(e,t,a){if(!e)return e;var i;void 0===t&&(t=e.id);a||(a=[]);var n=$.isArray(e.constants)?e.constants:[];a=a.concat(n);do{for(var s in i=!1,e){var o=e[s];if(!$.isNumeric(o)&&($.isArray(o)&&(e[s]=x(e,o)),!("string"!=typeof o||o.indexOf("$")<0||a.indexOf(s)>=0))){var d=o=o.replace("$id",t);e[s]=o=r.expandValue(e,o,t),i=d!==o}}}while(i);return e},this.expandArray=function(t){if(t.expand_data)return t[t.expand_data]=t[t.expand_data].concat(t.array),void delete t.array;$.each(t,function(a,r){var i=e.getMatches(r,/\$(\d+)/g);for(var n in i){var s=parseInt(i[n]);r=r.replace(new RegExp("\\$"+s+"([^d]|\b|$)","g"),t.array[s-1]+"$1")}t[a]=r})},this.parentSow=function(t,a){if(!t||!t.sow)return a;for(var r in t.sow){var i=t.sow[r],n={};n[i]=t[i],a=e.merge({},n,a)}return a};var _=function(t,a){if(t){for(var r in!a.parent_id&&t.id&&(a.parent_id=t.id),!a.parent_name&&t.name&&(a.parent_name=t.name),a.derive){var i=a.derive[r],n=a[i];void 0===n?a[i]=t[i]:$.isPlainObject(n)||$.isArray(n)?a[i]=e.merge({},t[i],n):"string"==typeof n&&"$"===n[0]&&(a[i]=t[n.substr(1)])}delete a.derive}};let w=function(t){let a=t.upgrade;return a?(e.each(a,(a,r)=>{let i=t[r];void 0!==i&&(i=e.copy(i),e.each(a,(a,n)=>{let s=new RegExp(n);e.isIterable(i)?e.some(i,(e,t)=>s.test(e)||s.test(t))&&(t[r]=e.extend(t[r],a)):s.test(i)&&(t[r]+=" "+a)}))}),delete t.upgrade,t):t};this.initField=function(t,a){t.page_id=this.page_id,t.template&&t.template.subject&&(t=e.merge({},t.template.subject,t),t.template.tag||delete t.template),_(a,t),t=this.parentSow(a,t),t=this.mergeType(t);var r=t.id;t.array&&t.array.length>1&&void 0===t.name&&(t.name=t.array[1]),"string"==typeof r&&void 0===t.name&&(t.name=e.toTitleCase(r.replace(/[_\/]/g," "))),t.array?this.expandArray(t):t=M(t);var i=["template","attr","text","html"];return this.expandValues(t,t.id,i),t.template&&t.template.subject&&(_(t.template,t),this.expandValues(t,t.id,i)),void 0!==t.class&&(e.isArray(t.class)||(t.class=[t.class]),t.class=t.class.reduce((e,t)=>"string"==typeof t?e.concat(t.split(" ")):e,[])),w(t),t};var b=function(e){return["table","thead","th","tbody","tr","td"].indexOf(e)>=0},k=function(t,a){a.jquery&&(e.replaceVars(a,a.params),t.call(a.jquery,a.params))},O=function(t,a){a.template||(e.toIntValue(a,"show"),e.toIntValue(a,"hide"),a.hide||!1===a.show||0===a.show?t.hide():a.show&&t.show())},j=function(t,a){e.toIntValue(a,"disabled"),t.prop("disabled",a.disabled)};this.render=function(e,t){var a=e[t]=r.initField(e[t],e);r.root_field=a;var i=r.root=r.create(e,t,!1);return r.initModel(i,a),i.on("values",function(e,t){if($.isPlainObject(t))i.setChildren(t,!0,Q);else for(var a in t)i.setChildren(t[a],!0,Q);r.respond(t),i.trigger("update_watchers")}),i};var P=function(e,t){var a=t.responsive;if(a){var r={small:"screen and (max-width:600px)",medium:"screen and (min-width:601px) and (max-width:992px)",large:"screen and (min-width:993px)"};for(var i in r){var n=a[i];n&&enquire.register(r[i],{match:function(){e.addClass(n.join(" "))},unmatch:function(){e.removeClass(n.join(" "))}})}}},C=function(e,t){if(!$.isPlainObject(t))return e.setClass(t);O(e,t),j(e,t),P(e,t),K(e,t),R(e,t),S(e,t)};this.create=function(a,n,s,o){var d=a;if("string"==typeof n||$.isNumeric(n)?(d=a[n],d||(d=i[n])):$.isPlainObject(n)&&(d=n),(void 0===s||s)&&(d=this.initField(d,a)),void 0===d.parent_page&&(d.parent_page=r.id),d.sub_page){var l=$("<div>loading...</div>");return this.createSubPage(a[n],l),l}d.id;if(void 0===d.html)return null;d.text=this.expandValue(d,d.text),d.html=this.expandValue(d,d.html),d.html=d.html.trim().replace(/\$tag(\W)/,d.tag+"$1");var c=b(d.tag),p=c?$("<"+d.tag+">"):$(d.html);d.is_body&&(p=$("body").append(p.html())),void 0===this.sink&&(this.sink=p);var u=["id","create","css","script","name","desc","data"];te(p,d),void 0===d.key&&(d.key=t.key);for(var f=$.extend({},this.types,d),v=e.getMatches(d.html,/\$(\w+)/g),g=0,h=0;h<v.length;++h){var m=v[h],y=f[m];if(void 0!==y)if("string"==typeof y&&y.search(/\W/)<0&&u.indexOf(m)<0&&(y=f[y]||y),$.isArray(y))void 0!==this.types[m]&&(y=$.merge($.merge([],this.types[m]),y)),this.expandFields(d,m,y),g+=this.createItems(p,d,m,y);else if($.isPlainObject(y)){y.path||(y.path=d.path+"/"+m),void 0===y.id&&(y.id=m),y.parent_page=d.parent_page;var x=this.create(d,m,!0);c&&p.append(x),d.html=="$"+m?p.html("").append(x):this.replace(p,x,m)}else p.replace(new RegExp("\\$"+m+"([^w]|\b|$)?","g"),y+"$1"),this.known[m]=y}return""===p.attr("id")&&p.removeAttr("id"),p.data("didi-field",d),C(p,d),d.parent&&o&&C(o,d.parent),k(p,d),"didi-functions"in d&&p.addClass("didi-watcher"),$.isPlainObject(d.position)&&p.position(d.position),N(p,d).then(function(){g&&r.setValues(p,d),D(p,d),p.triggerHandler("created",[d])}),("string"==typeof n||$.isNumeric(n))&&(a[n]=d),p},this.createSubPage=function(e,a,r){return null==a&&(a=$("<span>").text("loading...")),delete e.sub_page,delete e.appendChild,e.path=e.url?e.url:e.id,$.showPage($.extend({request:t.request},e),a).done(function(e,t,i){if(S(e,i),R(e,i),P(e,i),a.trigger("dying"),a.replaceWith(e),r){var n=/(\.[\w-][\w-\.]*)$/g.capture(r);n.length&&e.addClass(n[0].replace("."," "))}})},this.createItems=function(e,t,a,r,i){var n,s=!1;void 0===a||t.html.trim()==="$"+a||b(t.tag)||(n=new RegExp("(\\$"+a+")"));var o,d="_new_"+a,l='<div id="'+d+'"></div>',c=0;for(var p in r){var u=r[p],f=u.id;if("query"!=f){var v;++c,n&&e.replace(n,l+"$1");var g=this.create(r,p);u.template&&(v=this.create(u,"template"))?(b(u.template.tag)?v.append(g):this.replace(v,g,f,"field"),u.parent&&C(v,u.parent)):(v=g,delete u.template),o?o.append(v):u.wrap?(o=this.create(u,"wrap"),o.html(""),e.find("#"+d).replaceWith(o),o.append(v),delete u.wrap):n?e.find("#"+d).replaceWith(v):e.append(v)}else{if(s)continue;s=!0,this.loadData(e,t,a,u.defaults)}}return!s&&n&&e.replace(n,""),c},this.replace=function(e,t,a,r){a=a||t.attr("id"),r=r||a;var i="__new__"+a.replace(/[^\w]/g,"_"),n="<div id="+i+"></div>";return e.replace("\\$"+r,n),e.find("#"+i).replaceWith(t),t},this.loadData=function(e,t,a,i){this.loading++,e.on("loaded",function(t,n,s){0==--r.loading&&r.parent.trigger("loaded",s),null!=s?(void 0===i.attr&&(i.attr={}),i.attr.loaded="",e.find("[loaded]").exists()&&e.find("[loaded]").replaceWith("$"+a),r.expandFields(n,a,s,i),r.createItems(e,n,a,s,i),0===r.loading&&r.parent.trigger("loaded",[n,s])):console.log("No page data result for object: ",r.object," field ",n.id)}),(t.autoload||void 0===t.autoload)&&$.json("/",A("data",t.path+"/"+a,$.extend({},t.params,{key:t.key})),function(a){r.respond(a,e),e.trigger("loaded",[t,a.data])}),e.on("reload",function(n,s){t.autoload=!0,t.params=s,r.loadData(e,t,a,i),t.values&&r.loadValues(e,t)})};var A=function(e,a,i){return a||(a=r.path),{data:$.extend({},t.request,{key:t.key},i,{action:e,path:a})}},V=function(e){},F=function(e,t){if(t.listen){var a=$.isArray(t.listen)?t.listen:[t.listen];$.each(a,function(a,r){e.on(r,function(a,...i){e.trigger(r+"_"+t.id,[i])})})}},E=function(t,a){let i={};a.action&&(i.click=[a]);let n=a.id;F(t,a),$.each(a,function(e,a){if(0==e.indexOf("on_")){var r=e.substr(3);r in i||(i[r]=[]),$.isArray(a)?i[r]=i[r].concat(a):i[r].push(a),t.hasClass("didi-listener")||t.addClass("didi-listener")}}),$.each(i,function(i,s){$.each(s,function(s,o){$.isPlainObject(o)&&!o.path&&(o.path=a.path+"/on_"+i);var d=t;t.is("body")&&["scroll","resize"].indexOf(i)>=0&&(d=$(window));var l="on_"+i.replace(/\W/g,"_"),c=i.split("@"),p=c[0],u=c.length>1?c[1]:null;d.on(p,u,function(i){if(!t.hasClass("disabled"))if("click"==p&&"a"==t.prop("tagName").toLowerCase()&&(i.preventDefault(),void 0===a.url&&(a.url=t.attr("href"))),$.isPlainObject(o)){var s=Array.prototype.slice.call(arguments,1);o.params=e.merge({},o.params,s),e.replaceVars(o,o.params),J(i,t,o)}else if("didi-model"in a&&l in a["didi-model"]){var d=r.model[l+"_"+n];d&&d.apply(t,arguments),r.updateWatchers()}})})})},I=function(e,t){var a=y(t.trap);$.each(a,function(t,a){e.on(a,function(e){e.stopPropagation()})})},T=function(t,a){let r=a.triggers;if(!r)return;let i=this;$.each(r,function(a,r){e.asArray(r).forEach(function(r){let n,s=t,o=[];if("string"==typeof r)n=r;else{if(!$.isPlainObject(r))throw"triggered event must be either a string on an object";{[n,o]=e.firstElement(r),o=e.asArray(o);let a=o.shift();if(a){let[e,r,n,o]=/^(?:(self)|(parent)|(page)) (.*)$/g.capture(a);r?s=t.parent():n?s=i.root:e||(s=$(a)),o&&(s=s.find(o))}}}t.on(a,function(e,...t){s.triggerEx(n,[...o,...t])})})})},q=function(e,t){var a,r,i=y(t.toggles),n="click";switch(i.length){case 0:return;case 1:a=i[0];break;case 2:a=i[0],r=i[1];break;default:a=i[0],r=i[1],n=i[3]}e.on(n,function(){a==r?e.toggleClass(a):e.hasClass(a)?e.removeClass(a).addClass(r):e.removeClass(r).addClass(a)})},W=function(e,t){var a=t.events;a&&e.on(Object.keys(a).join(" "),function(t){e.setClass(a[t.type])})},D=function(e,t){if(q(e,t),W(e,t),!("attr"in t&&t.attr.for==t.id)){T(e,t),I(e,t),a(e,t),E(e,t),"string"==typeof t.enter&&e.keypress(function(a){13===a.keyCode&&e.find(t.enter).click()}),t.page_id=r.page_id,e.on("reload",function(a,r){t.params=r,Y(e,t)}).on("server_response",function(e,t){e.stopImmediatePropagation(),r.respond(t)}),V(e),e.on("post",function(e,a){t=$.extend({},t,{action:"post",params:[a]}),J(e,$(this),t)});var i=e.prop("tagName");if(i&&!(["input","select","textarea"].indexOf(i.toLowerCase())<0)){var n=ee(t);e.on("keyup input cut paste change",function(){let t=e.value(),a=""===t?"clear":"set";e.trigger(a);let i=r.model["set_"+n];i&&!i(t)||r.updateWatchers({invoker:e})})}}},N=function(e,t){return $.when(L("css",t),L("script",t)).then(function(a,i){t.create&&e.customCreate($.extend({render:r},t))})},K=function(t,a){e.replaceVars(a,a.attr,{sourceFirst:!0,recurse:!0});var r=a.attr;""===t.attr("id")&&t.removeAttr("id"),r&&("string"==typeof r?t.attr(r,""):$.each(r,function(r,i){if(a.array){var n=e.getMatches(i,/\$(\d+)/g);n.length&&(i=a.array[n[0]-1])}var s=e.getMatches(i,/\$(\w+)/g);for(var o in s){var d=s[o],l=a[d];void 0!==l&&"string"==typeof l&&(i=i.replace("$"+d,l))}t.attr(r,i)}),""===t.attr("id")&&t.removeAttr("id"))},R=function(e,t){e.setClass(x(t,t.class))},S=function(t,a){var i=a.immutable,n=function(){for(var t in"string"==typeof l&&(l=r.mergeType({},l.split(/[\s,]+/))),l){var a=r.mergeType({},l[t]);e.deleteKeys(a,i),$.extend(d,a)}},o=function(){for(var e in s){var t=s[e];if(!(i&&i.indexOf(t)>=0)){var r=a[t];void 0!==r&&"$"!==r[0]&&(d[t]=r)}}},d=a.style;d||(d={});var l=a.styles;l&&n(),e.replaceVars(a,d,{sourceFirst:!0,recurse:!0}),e.replaceVars(d,d,{sourceFirst:!0,recurse:!0}),o(),t.css(d)},M=function(t){var a=[];return $.each(t,function(e,t){"string"==typeof t&&t.match(/^\$\d+$/)&&a.push(e)}),e.deleteKeys(t,a),t},z=function(t,a,r){var i=t[a];return $.isPlainObject(i)?r=e.merge({},i,r):"string"==typeof r&&(r.type=i),r},B=function(t,a,i){if(1!=e.size(a))return!1;var s=i.sow,o=!1;for(var d in n){var l=n[d],c=a[l];if(void 0!==c&&("$"==c[0]&&(c=i[c.substring(1)]),void 0!==c)){if(s&&s.indexOf(c)>=0&&(c=e.merge({},i[c],t[l])),"template"===l&&"none"===c)c="$field";else if("wrap"===l&&$.isPlainObject(c))c=$.extend({},{tag:"div"},c);else if("type"===l||"template"===l||"wrap"===l)void 0===c&&console.log("undefined value",l,a),c=r.expandType(c);else if("types"===l){var p=[];for(var d in c)p.push(r.expandType(c[d]));c=p}"template"==l&&$.isPlainObject(a[l])&&void 0===a[l].type&&(c=z(t,l,r.initField(c)),e.replaceVars(c,c.subject,{recurse:!0})),t[l]=c,o=!0}}return U(t),o},L=function(e,t){var a=t[e];return"string"==typeof a&&(a=a.split(",")),null==a||0==a.length?$.when():$.when.apply($,$.map(a,function(t){return $.loadLink(t,e)}))},U=function(e){var t=e.attr;if(void 0!==t&&!$.isPlainObject(t)){var a={};return a[t]=t,e.attr=a,e}},H=function(a){$.isPlainObject(a)||(a={url:a}),e.replaceVars(a,a);var i=a.url;if((!i||a.query)&&"_blank"===a.target){i="/?action=action",a=$.extend({key:t.key},a);var n=["action","desc","html","id","name","page_id","query","selector","tag","target","text","type","template"];for(var s in a){var o=a[s];$.isPlainObject(o)||$.isArray(o)||n.indexOf(s)>=0||(i+="&"+s+"="+encodeURIComponent(a[s]))}}i&&("_blank"===a.target?window.open(i,a.target):a.target?($.closeDialog(r.sink),r.createSubPage({url:i,key:a.key},$(a.target),a.target)):document.location=i)},J=function(e,t,a,i){a.page_id=a.page_id||t.closest(".page").attr("id");var n=function(e){var a=e&&$.isPlainObject(e._responses)&&"errors"in e._responses?"error":"success";t.trigger("post_"+a,[e])},s=function(i){var s=[];switch($.isArray(i)&&(s=i.slice(1),i=i[0]),!a.url&&["dialog","redirect"].includes(i)&&(a.url=a.path.split("/")[0]+"/"+a.id),i){case"page":return void $.showPage(a);case"dialog":return void $.showDialog(a.url,$.extend({key:a.key},s[0]));case"close_dialog":$.closeDialog(t);break;case"redirect":H(a);break;case"post":var o=a.url?a.url:a.path;s=A("action",o,{key:a.key});var d=a.selector||"#page *";d=d.replace(/(^[^\w]+)page([^\w]+)/,"$1"+a.page_id+"$2"),s=$.extend(s,{invoker:t,event:e,async:!0,post_prefix:a.post_prefix}),r.sink.find(".error").remove(),r.sink.find(".in-error").unsetClass("in-error").trigger("clear-error"),t.trigger("posting",[s]),$(d).json("/",s,function(a){n(a),r.respond(a,t,e)});break;case"trigger":Z(a,t);break;default:i&&"."==i[0]&&t[i.substring(1)].apply(t,s)}},o=function(){void 0===i&&(i=a.action),$.isArray(i)?i.forEach(s):s(i)};!a.confirmation||i?o():$.showDialog("/confirm_dialog").done(function(e){"string"==typeof a.confirmation&&e.find("#message").text(a.confirmation),e.find(".action").click(function(){$.closeDialog(e),"yes"===$(this).attr("action")&&o()})})},X=function(e,t){if("alert"!=e){var a,i=r.sink.find("#"+e+",[name='"+e+"']");if(i.hasClass("error-sink"))a=i;else{var n=i.parents(".error-sink");n.exists()||(n=i.parents("[for='"+e+"']")),a=n.exists()?n.eq(0):i}if(i.trigger("errors",[t]),a.addClass("in-error").attr("error-message",t),!a.hasClass("no-error-box")&&!i.hasClass("no-error-box")){var s=$("<div class=error>"+t+"</div>");a.after(s);var o=parseInt(a.css("z-index"));s.css("z-index",o+1),s.fadeIn("slow").click(function(){$(this).fadeOut("slow")})}}else alert(t)},G=function(e,t){for(var a in e)X(a,e[a]);t&&t.stopImmediatePropagation()};this.respond=function(t,a,i){if(t){e.removeXSS(t);var n=t._responses;if(delete t._responses,!$.isPlainObject(n))return this;var s=r.sink;a?(s=a.parents("#"+r.page_id).eq(0),s.exists()||(s=r.sink)):a=s;var o=function(e,t){switch(e){case"alert":alert(t);break;case"show_dialog":$.showDialog(t,n.options);break;case"close_dialog":$.closeDialog(s,t);break;case"redirect":H(t);break;case"update":s.setChildren(t,!0);break;case"trigger":Z(t,s);break;case"error":X(t);break;case"errors":G(t)}};for(var d in n){var l=n[d];if($.isArray(l))for(var c in l)o(d,l[c]);else o(d,l)}}},this.setValues=function(t,a){var r;for(var i in a.values){var n=a.values[i],s=$.isNumeric(i);if(!s||$.isPlainObject(n)){var o=i,d=n;if(s){var l=e.firstElement(n);o=l[0],n=l[1]}var c=t.find(e.selector.idName(o));c.exists()?c.value(d):"query"===o&&(r=!0)}}r&&(t.on("load_values",function(e,a){Y(t,a)}),(void 0===t.auto_load||t.auto_load)&&t.trigger("load_values",[a]))};var Q=function(e,t){t=t||{update_watchers:!0};let a=e.data("didi-field");if(!a||!a.id)return;var i=r.model["set_"+a.id];let n=e.value();e.trigger(""===n?"clear":"set"),i&&!i(n)||!t.update_watchers||r.updateWatchers({invoker:e})},Y=function(e,t){var a=$.extend({key:t.key},t.params);$.json("/",A("values",t.path,a),function(t){t&&e.trigger("values",[t])})},Z=function(e,t){var a;e.event||(e.event=e.id);var i,n=e.event;if($.isPlainObject(n)?(a=n.sink,r.expandValues(n.parameters,e.id),i=n.parameters,n=n.name):(a=e.sink,i=e.params,void 0===i||$.isArray(i)||(i=[i]),("toggle"==n||".toggle"==n&&void 0!==i)&&(i=[1===parseInt(i[0])||!0===i[0]])),a){var s=a;a=$(a.replace(/(^|[^\w]+)page([^\w]*)/,"$1"+r.id+"$2")),a.exists()||(a=window.parent.$(s))}else a=t||$(".didi-listener");"loaded_values"==n&&console.log("loaded_values",a,i),a.triggerEx(n,i)},ee=function(e){return e.attr&&"radio"==e.attr.type?e.attr.name:e.id},te=function(e,t){function a(e,t,a){var r;a=a.trim(),r=/^~|\s*function\s*\([^)]*\)/gm.test(a)?[a]:/(`[^`]+`)/g.capture(a);var i=!1;t=t.replace(/\W/g,"_"),r.forEach(function(e,r){if(e){var n,l="\n\t}",c=/\breturn\s/gm.test(e)?"":"\t\treturn ";0!=t.indexOf("on_")?n="\tget_"+d+"_"+o+": function(obj) {\n"+c:/^[~`]?\s*function\s*\(/gm.test(e)?(n="\t"+t+"_"+d+": ",l=""):n="\t"+t+"_"+d+": function(event) {\n",n+=e.replace(/^~|`/g,"")+l,s.push(n),a=a.replace(e,"${"+o+"}"),i=!0,++o}}),i&&(e["didi-model"][t]=a)}function r(t,a){for(var r in a){var i=a[r].script;if(!i)return;/^[~`]?\s*function\s*\(/gm.test(i)&&(i="function(event) { "+i+" }");var n=e;e.is("body")&&"scroll"==t&&(n=$(window)),n.on(t,$.proxy(Function(i),e))}}function i(e,t){if("html"!=t){var i=e[t];"string"==typeof i?a(e,t,i):0==t.indexOf("on_")&&$.isArray(i)&&r(t.substr(3),i)}}function n(e){if(e)for(var t in e["didi-model"]={},e)i(e,t)}var s=[],o=0,d=t.id;n(t),n(t.style),n(t.class),s.length&&(t["didi-functions"]=s)};this.initModel=function(e,t){var a=[],i=t.id;t.dd_init&&$.each(t.dd_init,function(e,t){a.push(e)}),e.find("input,select,textarea,.isearch").addBack("input,select,textarea,.isearch").each(function(){var e=$(this).data("didi-field");if(e&&e.parent_page==i){var t=ee(e);a.indexOf(t)<0&&a.push(t)}});var n=a.map(function(e){return"\tset_"+e+": function(x) {\n\t\tvar changed = ("+e+" !== x);\n\t\t_old_"+e+"="+e+";\n\t\t"+e+"=x\n\t\treturn changed;\n\t},\n\tchanged_"+e+": function(x) {\n\t\treturn x!=="+e+";\n\t}"});if(e.find(".didi-watcher").addBack(".didi-watcher").each(function(){var e=$(this).data("didi-field");e&&e.parent_page==i&&(n=n.concat(e["didi-functions"]))}),r.model_funcs&&(n=r.model_funcs.concat(n)),r.model_funcs=n,n.length){n="\nreturn {\n"+n.join(",\n")+"}";var s="";a.length&&(a="var "+a.map(function(e){return e+"='',_old_"+e+"=''"}).join(",")),t.js&&$.each(t.js,function(e,t){/^\s*function\(/.test(t)?s+="\n"+t.replace(/^s*function\s*(\([^)]*\))/m,"function "+e+"$1")+"\n":s+="var "+e+" = "+t+";\n"}),s+="\n"+a,t.js_functions&&(s+="\n\n"+t.js_functions+"\n\n"),r.model_src&&(s=r.model_src+s),s+=n,r.model_src=s,r.model=new Function(s)(),t.dd_init&&$.each(t.dd_init,function(e,t){r.model["set_"+e](t)}),e.on("update_watchers",function(t){r.updateWatchers({root:e})}).trigger("update_watchers")}},r.updateWatchers=function(t){function a(t,a,i){if(!a||!a["didi-model"])return!1;var n=!1;return $.each(a["didi-model"],function(s,o){if(0!=s.indexOf("on_")){var d=/\$\{(\d+)\}/g.capture(o),l="get_"+i+"_";d.forEach(function(i){var d=r.model[l+i];if(void 0!==d){var c=d(t),p="\\$\\{"+i+"\\}",u=o;o=new RegExp("^"+p+"$","g").test(o)?c:o.replace(new RegExp(p,"g"),c),o!==u&&(n=!0),a[s]=o,"text"==s&&t.text(o),"value"==s&&(a.precision&&e.isNumeric(o)&&(o=parseFloat(o).toFixed(a.precision)),t.val(o),Q(t,{update_watchers:!1}))}})}}),n}let i=t&&t.root||r.root,n=t&&t.invoker||void 0;var s=i.data("didi-field");if(!s)return;var o=s.id;let d=null;if(n){let e=n.data("didi-field");d=e&&e.id}i.find(".didi-watcher").addBack(".didi-watcher").each(function(){var e=$(this);if(e.is(n))return;var t=e.data("didi-field");if(!t||t.parent_page!=o)return;let r=t.peers;if(!r||r.includes(d)){var i=t.id||e.attr("for"),s=a(e,t,i),l=a(e,t.style,i),c=a(e,t.class,i);s&&K(e,t),(s||c)&&R(e,t),(s||l)&&S(e,t),s&&O(e,t),s&&j(e,t)}})}}})(didi);