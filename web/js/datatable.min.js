(function(t){t.widget("didi.datatable",{options:{name:"Untitled",flags:[]},_create:function(){var e=this;e.widths=[];var i=e.options;if(i.sort)i.flags.push("sortable");var a=i.render;a.expandFields(i,"fields",i.fields);var n=a.initField(i.row,i);e.row_classes=i.row.class.join(" ");e.cell=a.initField(i.cell,i);e.cell.class=e.cell.class.join(" ");t.extend(i.row_styles,i.row.styles);i.row_actions=i.row_actions.concat(i.row.actions);i.render.expandFields(i,"row_actions",i.row_actions);e.auto_widths=[];e._init_params();var s=e.element;e.head().addClass(i.head.class.join(" ")).prependTo(s);e.showHeader();e.showTitles();e.createRowBlueprint();if(i.no_records)this.no_records=this.element.find("#no_records");e.head().toggle(e.hasFlag("show_titles")||e.hasFlag("show_header")||e.hasFlag("filter"));e.showFooterActions();if(i.auto_load){var r=t.isPlainObject(a.request)?a.request:{};e.showData(r)}s.on("refresh",(function(t,a){s.trigger("refreshing",a);e.showData(a);return i.propagated_events.indexOf(t.type)>=0})).on("addData",(function(t,a){s.trigger("addingData",a);e.load(a);return i.propagated_events.indexOf(t.type)>=0})).on("updateData",(function(t,a){console.log("updateData",a);s.trigger("updatingData",a);e.updateData(a);return i.propagated_events.indexOf(t.type)>=0}));e.body().scroll(t.proxy(e._scroll,e));e.bindRowActions()},_init_params:function(){this.params={page_num:1,offset:0};var t=["create","action","css","id","content","disabled","parent_name","parent_id","parent_page","auto_load","searchDelay","number","data_from","min_row_height","desc","index","html","name","page_id","position","sort","script","slideSpeed","text","tag","target","type","show","selector","js"];for(var e in this.options){if(t.indexOf(e)>=0||e.indexOf("on_")==0)continue;var i=this.options[e];if(typeof i==="string"||typeof i==="number")this.params[e]=i}var a=this.options.sort;if(typeof a!="string")return;var n=this.options.fields;for(var s in n){var r=n[s];if(r.id!=a)continue;this.params["sort"]=r.number;return}},_promote_fields:function(e){t.each(e,(function(i,a){if(!t.isPlainObject(a))e[i]=dd.toObject(a)}))},refresh:function(t){this.element.trigger("refresh",[t])},head:function(){return this.element.children("thead").eq(0)},body:function(){return this.element.children("tbody").eq(0)},load:function(e){e=e||{};var i=(new Date).getTime();var a=this;var n=a.options;a.head().find(".paging [action]").attr("disabled","");var s=n.data_from=="post"?"action":"values";var r=t.extend(n.request,a.params,e,{action:s});var o=n.selector;if(o!==undefined){t.extend(r,t(o).values())}var d=a.element;a.loading=true;t.json("/",{data:dd.plainValues(r)},(function(n){if(!n){d.triggerHandler("refreshed",[n]);return}if(n._responses)d.triggerHandler("server_response",[n]);var s=(new Date).getTime();console.log("Load: ",s-i);a.populate(n,e.insert_at);a.loading=false;console.log("Populate: ",(new Date).getTime()-s);delete n.data;t.extend(a.params,n);d.triggerHandler("refreshed",[n])}))},populate:function(e,i){if(e===undefined||e===null||!e.data){console.log("No table data for table:",this.params.field);return}if(this.cell_render)delete this.cell_render;var a=this.options;var n=this.cell_render=new dd.render({invoker:a.render.root,model_src:a.render.model_src,model_funcs:a.render.model_funcs,types:a.render.types,id:a.id,key:a.key,request:a.request});if(this.options.page_size!==undefined)this.showPaging(parseInt(e.total));this.no_records.hide();if(e.data.length==0&&this.body().children().length==0&&this.no_records)this.element.append(this.no_records.show());this.prev_row=null;for(var s in e.data){var r=e.data[s];if(t.isArray(r)){this.addRow(r,i);this.prev_row=r}}this.adjustWidths();n.root=this.element;if(!a.js_functions)a.js_functions=a.render.root_field.js_functions;n.initModel(n.root,a)},hasFlag:function(t){return this.options.flags.indexOf(t)>=0},hasHeader:function(){var t=this.options;return t.name!==undefined&&t.page_size!==undefined},showHeader:function(){var e=this.head();e.html("");var i=t("<tr class=header></tr>").appendTo(e);var a=t("<th></th>").appendTo(i);if(this.options.name!==undefined&&this.hasFlag("show_header"))t("<div class=heading></div>").html(this.options.name).appendTo(a);var n=this;if(this.hasFlag("filter")){this.createAction("filter").appendTo(a);this.element.on("filter",(function(t){n.showFilter();t.stopImmediatePropagation()}))}if(this.options.page_size!==undefined&&!this.hasFlag("hide_paging"))this.createPaging(a)},createPaging:function(e){var i=t("<div class=paging></div>").appendTo(e);t("<div>Showing from </div>").appendTo(i);t("<div id=page_from></div>").appendTo(i);t("<div>to</div>").appendTo(i);t("<div id=page_to></div>").appendTo(i);t("<div>of</div>").appendTo(i);t("<div id=page_total></div>").appendTo(i);t("<div>at</div>").appendTo(i);t("<input id=page_size type=text></input>").val(this.options.page_size).appendTo(i);t("<div>entries per page</div>").appendTo(i);this.createAction("goto_first").attr("disabled","").appendTo(i);this.createAction("goto_prev").attr("disabled","").appendTo(i);t("<input id=page_num type=text></input>").val(1).appendTo(i);this.createAction("goto_next").attr("disabled","").appendTo(i);this.createAction("goto_last").attr("disabled","").appendTo(i);this.bindPaging()},pageTo:function(t,e){if(t.hasAttr("disabled"))return;this.params.page_num=e;this.params.size=t.siblings("#page_size").val();t.siblings("#page_num").val(e);this.refresh()},page:function(t,e){this.pageTo(t,parseInt(t.siblings("#page_num").val())+e)},bindPaging:function(){var e=this;var i=e.head();i.find(".paging [type='text']").bind("keyup input cut paste",(function(i){if(i.keyCode===13){e.params.size=t(this).val();e.refresh()}}));var a=i.find("#page_num");this.element.on("goto_first",(function(t,i){e.pageTo(i,1)})).on("goto_prev",(function(t,i){e.page(i,-1)})).on("goto_next",(function(t,i){e.page(i,1)})).on("goto_last",(function(t,a){var n=parseInt(i.find("#page_size").val());var s=parseInt(i.find("#page_total").html());e.pageTo(a,Math.floor(s/n)+1)}))},showPaging:function(t){var e=this.head();e.find("#page_total").text(t);var i=this.params.page_num;var a=this.params.size;var n=e.find("[action=goto_first],[action=goto_prev]");var s=e.find("[action=goto_last],[action=goto_next]");if(i<=1){i=1;n.attr("disabled","");e.find("#page_num").val(1)}if(a>=t)e.find("#page_num").val(1);e.find("#page_from").text((i-1)*a+1);e.find("#page_to").text(Math.min(i*a,t));if(i>=t/a)s.attr("disabled","");else s.removeAttr("disabled");if(i>1)n.removeAttr("disabled")},bindSort:function(t,e){var i=this;t.click((function(){t.siblings().attr("sort","");var a="asc";if(i.params.sort==e.number)a=t.attr("sort")==="asc"?"desc":"asc";t.attr("sort",a);i.params.sort=e.number;i.params.sort_order=a;i.refresh()}))},showTitles:function(){var e=this.head();var i=this.options;var a=e.find(".titles").empty();if(!a.exists())a=t("<tr class=titles>").appendTo(e);if(!this.hasFlag("show_titles"))a.hide();var n=this;var s=i.fields;var r=i.title.class.join(" ");for(var o in s){var d=s[o];var l=d.id;if(d.id=="style"||d.data)continue;var f=t("<th></th>").addClass(r).appendTo(a);f.toggle(dd.visible(d));f.data("field",d);if(d.class)f.addClass(d.class.join(" "));if(l==="actions"){d.filter=false;continue}if(t.isArray(d.name))d.name=d.name[d.name.length-1];f.html(d.name||dd.toTitleCase(l));if(n.hasFlag("sortable")){if(l===n.params.sort)f.attr("sort",n.params.sort_order);else f.attr("sort","")}if(d.width!==undefined){f.css("width",d.width)}if(n.hasFlag("sortable"))n.bindSort(f,d)}this.spanColumns(e.find(".header th"));this.updateWidths(e.find(".titles").children())},createRowBlueprint:function(){var e=this;var i=t("<tr>").addClass(e.row_classes);var a=e.cell.class;e.defaults={};var n=e.options;var s=n.fields;for(var r in s){var o=s[r];e.defaults[o.id]=o.new;delete o.new;if(o.id=="style"||o.data)continue;var d=t("<td>").appendTo(i);d.attr("field",o.id);d.toggle(dd.visible(o));d.addClass(a);if(o.style)d.addStyle(o.style,n.cell.styles);if(o.class)d.addClass(o.class.join(" "));if(o.html===undefined)continue;o=dd.copy(o);delete o.width;d.append(e.options.render.create(o))}e.row_blueprint=i},spanColumns:function(t){var e=this.head().find(".titles");if(!e.exists())e=this.body().children("tr").eq(0);t.attr("colspan",e.children().length)},spanData:function(t,e,i){if(t.span<=1)return e[i];var a=e.slice(i,i+t.span);return a.join(" ")},showData:function(e){var i=this;var a=i.body();var n=i.options;var s=parseInt(a.css("max-height"));if(n.page_size==0||s>0){var r=parseInt(t("<tr><td>Loading...</td></tr>").appendTo(a).height());if(r<1)r=n.min_row_height;i.params.size=Math.ceil((s-i.head().height())/r)+3}a.addClass(n.body.class.join(" "));a.empty();i.load(e);i.spanColumns(i.head().find(".header>th"))},updateData:function(e){e=e||{start_row:0,start_col:0};var i=(new Date).getTime();var a=this;var n=a.options;var s=n.data_from=="post"?"action":"values";var r=t.extend(n.request,a.params,e,{action:s});var o=n.selector;if(o!==undefined){t.extend(r,t(o).values())}var d=a.element;a.loading=true;t.json("/",{data:dd.plainValues(r)},(function(t){if(!t){d.triggerHandler("updated",[t]);return}if(r._responses)d.triggerHandler("server_response",[resut]);var n=(new Date).getTime();console.log("Load: ",n-i);var s=e.start_row;var o=e.start_col;var l=a.body().children();for(var f in t.data){a.updateRow(l.eq(s++),t.data[f],o)}a.loading=false;d.triggerHandler("updated",[r]);console.log("Update: ",(new Date).getTime()-n)}))},setRowStyles:function(e,i){var a=this.options.row_styles;if(!a)a=this.options.row.styles;e.attr("class","");e.addClass(this.row_classes);if(t.isPlainObject(i))i=dd.firstKey(i);e.addStyle(i,a)},addRow:function(e,i){var a=this.row_blueprint.clone(true);this.updateRow(a,e);var n=this.body();if(i===undefined)a.appendTo(n);else if(t.isNumeric(i))a.insertBefore(n.children().eq(i));else a.insertBefore(n.find(i))},updateRow:function(e,i,a){var n=this;var s;var r=false;a=a||0;var o=a;var d=this.options.fields;var l=e.children();var f=d.length-a;var p=0;for(var h=0;h<f;++h){var c=d[a++];var u=i[h];if(c.id=="style"&&u!==undefined){n.setRowStyles(e,u);continue}if(c.data){e.data(c.id,u);if(c.attr)e.attr(c.id,u);continue}if(p&&--p)continue;var v=l.eq(o++);if(u===undefined||u===null)u={name:""};else if(!t.isPlainObject(u)){if(u[0]==="{"){try{u=JSON.parse(u)}catch{u={name:u}}}else{u={name:u}}}if(u.id===undefined){u.id=c.id;if(s)u.id+="_"+s}i[h]=u;if(this.prev_row&&this.prev_row[h]&&this.prev_row[h].row_span>1){u.row_span=parseInt(this.prev_row[h].row_span)-1;i[h]=u;v.addClass("hide")}else if(u.row_span){v.attr("rowspan",u.row_span)}if(u.col_span){p=parseInt(u.col_span);v.attr("colspan",p);for(var g=1;g<p;++g)l.eq(o++).remove()}if(u===null||u===undefined)u=this.options.defaults[c.id];else if(c.escapeHtml)u=dd.escapeHtml(u);if(s===undefined&&(c.id==="key"||c.key)){e.attr("key",u.name);s=u.name}n.setCellValue(v,u)}n.adjustColWidths(e);this.prev_row=i},adjustColWidths:function(e){var i=this.widths;e.children().each((function(e){var a=t(this).width();if(e==i.length)i.push(a);else if(i[e]<a)i[e]=a}))},setCellValue:function(t,e){if(!e.name)e.name="";if(!e.value)e.value=e.name;if(t.attr("field")=="actions")return this.createRowActions(t,e.value);if(t.hasClass("expandable"))return t.find(".text").eq(0).text(e.name);if(e.class||this.options.cell.class)t.setClass(this.options.cell.class.concat(e.class));if(e.style)t.addStyle(e.style,this.options.cell.styles);if(e.key)t.attr("key",e.key);if(e.type){e.path=this.options.path+"/cell/controls/"+e.type;var i=this.cell_render.create(this.options.cell,e,true,t);i&&t.append(i)}if(e.data){t.data(JSON.parse(e.data))}var a=t.children().eq(0);if(!a.exists())return t.text(e.value).attr("title",e.title?e.title:e.name);a.value(e.value);return t},applyStyle:function(e,i,a){var n=this;if(!t.isArray(a))a=a.split(" ");a.forEach((function(t){e.addClass(t);var a=i[t];if(!a)return;a.forEach((function(t){if(t[0]=="~")n.removeStyle(e,i,t.substr(1));else if(t[0]=="^")e.removeClass(t.substr(1));else e.addClass(t)}))}))},removeStyle:function(t,e,i){var a=e[i];if(a)t.removeClass(a.join(" "))},bindAction:function(e,i,a,n){if(a===undefined)a=this.element;var s=this.element;e.click((function(){var r=i.id;a.trigger("action",[e,r,i]);a.trigger(r,[e,i]);if(i.action===undefined)return;var o=a.attr("key");if(o===undefined)o=s.options.key;var d=t.extend({},s.params,i,{id:r,action:i.action,key:o});var l=s.closest(".page").eq(0);d.path+="/";if(n!==undefined)d.path+=n+"/";d.path+=r;l.trigger("child_action",[e,d])}))},findField:function(t,e){for(var i in e){if(t===e[i].id)return e[i]}},createAction:function(e,i,a,n){var s;if(i){s=this.findField(e,i);if(!s)s=this.options[e]}else if(t.isPlainObject(e)){s=e;e=s.id}else s=this.options[e];if(!s||t.isEmptyObject(s))return t("");var r=t("<span>");if(s.name===undefined)s.name=dd.toTitleCase(e);r.html(s.name);r.attr("title",s.desc);r.attr("action",e);s.id=e;this.bindAction(r,s,a,n);return r},createExpandActions:function(e){var i=e.parent();i.children().each((function(){if(t(this).css("display")!="none"){e=t(this);return false}}));e.addClass("expandable");var a=t("<span>").addClass("text").text(e.text());e.text("").append(a);this.createAction("expand",undefined,i).prependTo(e);this.createAction("collapse",undefined,i).prependTo(e).hide()},createRowActions:function(e,i){if(!i)return;if(!t.isArray(i))i=i.split(",");if(i.indexOf("expand")>=0)this.createExpandActions(e);if(i.indexOf("slide")>=0)i.push("slideoff");if(!e.hasClass("actions"))e.addClass("actions");e.empty();var a=this.options;var n=a.row_actions;var s=e.parent().attr("key");var r=[];var o=[];var d=r;var l=-1;for(var f in n){var p=dd.copy(n[f]);var h=p.id;if(i.indexOf(h)<0)continue;p.key=s;p=dd.merge(p,a[h]);d.push(p);if(h=="slide"){d=o;l=f}}if(o.length==1)r.splice(l,1);if(r.length)a.render.createItems(e,{},undefined,r);if(o.length<2)return;var c=t('<div class="slide">').toggle(false).appendTo(e);c.data("actions",o)},slide:function(e){var i=this.getActionsHeight(e);var a=e.find(".slide");if(a.children().length==0){this.options.render.createItems(a,{},undefined,a.data("actions"));a.find("[action]").click((function(){a.parent().trigger("action",[t(this),"",t(this).attr("action")])}));a.data("width",a.width());a.width(0)}a.show().animate({width:a.data("width")},this.options.slideSpeed)},loadSubPages:function(e,i){var a=t("<tr class=expanded></tr>");var n=t("<td></td>").attr("colspan",e.children("td").length).addClass(this.options.expand.class.join(" ")).prependTo(a);a.insertAfter(e);var s=e.attr("key");var r=t("<div></div>");var o=0;var d=function(){var e=i[o];t.showPage({path:e,key:s},n).done((function(){if(++o<i.length)d()}))};d()},bindRowActions:function(){var e=this;var i=e.options;var a=this.element;a.on("slide","tr",(function(i){t(i.target).toggle();e.slide(t(this));i.stopPropagation()})).on("expand","tr",(function(a){var n=t(this);n.find("[action=expand]").hide();n.find("[action=collapse]").show();if(n.next().hasClass("expanded"))return;var s=i["expand"];if(!s.pages)return;e.loadSubPages(n,s.pages);a.stopPropagation()})).on("collapse","tr",(function(e){var i=t(this);i.find("[action=collapse]").hide();i.find("[action=expand]").show();var a=i.next();if(a.hasClass("expanded"))a.remove();e.stopPropagation()})).on("action","tr",(function(a,n){if(!n.parent(".slide").exists())return;e.slide(t(this));var s=t(this).find("[action=slide]");var r=t(this).find(".slide");r.animate({width:0},i.slideSpeed*2,(function(){r.hide();s.show()}));a.stopPropagation()})).on("delete","tr",(function(e){t(this).remove();return t(this)})).on("delete",(function(t){t.stopPropagation()})).on("setRowStyles",(function(i,n,s){if(!t(i.target).is(a))return;e.setRowStyles(e.getRowByKey(n),s)})).on("setRowActions",(function(i,n,s){if(!t(i.target).is(a))return;var r=e.getRowByKey(n);e.createRowActions(e.getCellById(r,"actions"),s)})).on("setCellValue",(function(i,n,s,r){if(!t(i.target).is(a))return;var o=e.getRowByKey(n);e.setCellValue(e.getCellById(o,s),{name:r})})).on("setRowData",(function(i,n,s){if(!t(i.target).is(a))return;e.setRowData(e.getRowByKey(n),s)})).on("addRow",(function(i,n){if(!t(i.target).is(a))return;e.addRow(n);e.adjustWidths()})).on("addNewRow",(function(i,n){if(!t(i.target).is(a))return;var s=e.row_blueprint.clone(true);e.body().prepend(s);e.setRowData(s,n);e.adjustWidths()})).on("removeRow",(function(t,i){e.getRowByKey(i).remove()}))},setRowData:function(e,i){i=t.extend({},this.options.defaults,i);if("key"in i)e.attr("key",i["key"]);for(var a in i){var n=i[a];if(a=="style")this.setRowStyles(e,n);else this.setCellValue(this.getCellById(e,a),n)}},getCellById:function(t,e){return t.children('[field="'+e+'"]').eq(0)},getRowByKey:function(t){return this.body().children('[key="'+t+'"]').eq(0)},getActionsHeight:function(t){return(t.innerHeight()*.99).toString()+"px"},initWidths:function(t,e){var i=this.options.fields;var a=this.widths;var n=-1;for(var s in i){var r=i[s];if(r.id=="style"||r.type=="type")continue;++n;var o=t.eq(n);var d=e.eq(n);if(r.width!==undefined){if(o.exists()){o.css("width",r.width);d.css("width",o.get(0).style.width)}else{d.css("width",r.width)}}else if(r.width!=="auto"){o.css("width","auto");d.css("width","auto")}}},updateWidths:function(e){var i=this.widths;e.each((function(e){var a=t(this).width();if(e===i.length)i.push(a);else if(a>i[e])i[e]=a}))},adjustWidths:function(){if(this.options.adjust_widths!==undefined&&!this.options.adjust_widths)return;var t=this.head().find(".titles").children();var e=this.body().find("tr:first-child");var i=e.children();this.initWidths(t,i);this.updateWidths(i);var a=this.widths;if(!a.length)a=[];var n=a.reduce((function(t,e){return t+e}),0);var s=this.options.fields;var r=0;for(var o in s){var d=s[o];if(d.id=="style"||d.data)continue;if(d.width!==undefined)continue;var l=t.eq(r);var f=a[r]/n*100+"%";if(l.exists()){l.css("width",f);f=l.get(0).style.width}i.eq(r).css("width",f);++r}},createEditor:function(e,i){var a=e.clone(true);var n;a.addClass("datatable-editor").addClass(i).removeClass("title");a.children().each((function(e){var i=t(this);var a=i.data("field");if(a&&a.id=="actions")return;i.text("");i.append(t("<input type=text></input>").addClass("tallest widest"))}));a.insertAfter(e);return a},createFilter:function(){var e=this.head().find(".filter");if(e.exists())return e;var i=this;var a=i.head().find(".titles");e=i.createEditor(a,"filter").hide();var n=e.children();e.find("input").bind("keyup cut paste",dd.debounce((function(e){var a=t(this);i.params.offset=0;var s=a.parent();var r=n.index(s);i.params["f"+r]=a.value();i.refresh()}),i.options.search_delay)).on("click",(function(t){t.stopImmediatePropagation()}));return e},showFilter:function(){var t=this.createFilter();t.toggle();if(t.is(":visible"))this.adjustWidths(t)},showFooterActions:function(){this.options.render.expandFields(this.options,"footer_actions",this.options.footer_actions);var e=this.options.footer_actions;if(!e.length)return;var i=t("<tfoot>").appendTo(this.element);var a=t("<tr>").addClass("actions").appendTo(i);var n=t("<td>").appendTo(a);var s=this.options.key;e.map((function(t){t.key=s;return t}));this.options.render.createItems(n,this.options,undefined,e);this.spanColumns(n)},_scroll:function(t){var e=this;var i=e.opts;var a=e.body();if(a.scrollHeight()-a.scrollTop()!=a.height()||e.loading)return;if(e.params.total&&e.params.offset+e.params.size>e.params.total)return;e.params.offset+=e.params.size;e.load()}})})(jQuery);