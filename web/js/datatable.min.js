(function(t){t.widget("didi.datatable",{options:{name:"Untitled",flags:[]},_create:function(){var e=this;e.widths=[];var i=e.options;i.sort&&i.flags.push("sortable");var a=i.render;a.expandFields(i,"fields",i.fields);a.initField(i.row,i);e.row_classes=i.row.class.join(" "),e.cell=a.initField(i.cell,i),e.cell.class=e.cell.class.join(" "),t.extend(i.row_styles,i.row.styles),i.row_actions=i.row_actions.concat(i.row.actions),i.render.expandFields(i,"row_actions",i.row_actions),e.auto_widths=[],e._init_params();var s=e.element;e.head().addClass(i.head.class.join(" ")).prependTo(s),i.no_records&&(this.no_records=this.element.find("#no_records"));var n=t.isPlainObject(a.request)?a.request:{};e.reload(n),s.on("reload",function(t,i){e.reload(i)}).on("refresh",function(t,a){return s.trigger("refreshing",a),e.showData(a),i.propagated_events.indexOf(t.type)>=0}).on("addData",function(t,a){return s.trigger("addingData",a),e.load(a),i.propagated_events.indexOf(t.type)>=0}).on("updateData",function(t,a){return console.log("updateData",a),s.trigger("updatingData",a),e.updateData(a),i.propagated_events.indexOf(t.type)>=0}),e.body().scroll(t.proxy(e._scroll,e)),e.bindRowActions()},reload:function(t){let e=this;t.key&&(e.options.key=e.params.key=t.key),e.showHeader(),e.showTitles(),e.head().toggle(e.hasFlag("show_titles")||e.hasFlag("show_header")||e.hasFlag("filter")),e.createRowBlueprint(),e.showFooterActions(),e.options.auto_load&&e.showData(t),e.element.trigger("reloaded",[t])},_init_params:function(){this.params={page_num:1,offset:0,size:this.options.page_size};var t=["create","action","css","id","content","disabled","parent_name","parent_id","parent_page","auto_load","searchDelay","number","data_from","min_row_height","desc","index","html","name","page_id","position","sort","script","slideSpeed","text","tag","target","type","show","selector","js"];for(var e in this.options)if(!(t.indexOf(e)>=0||0==e.indexOf("on_"))){var i=this.options[e];"string"!=typeof i&&"number"!=typeof i||(this.params[e]=i)}var a=this.options.sort;if("string"==typeof a){var s=this.options.fields;for(var n in s){var o=s[n];if(o.id==a)return void(this.params.sort=o.number)}}},_promote_fields:function(e){t.each(e,function(i,a){t.isPlainObject(a)||(e[i]=dd.toObject(a))})},refresh:function(t){this.element.trigger("refresh",[t])},head:function(){return this.element.children("thead").eq(0)},body:function(){return this.element.children("tbody").eq(0)},load:function(e){e=e||{};var i=this,a=i.options,s=(new Date).getTime();i.head().find(".paging [action]").attr("disabled","");var n="post"==a.data_from?"action":"values",o=i.params;o.offset=(o.page_num-1)*o.size;var r=t.extend(a.request,o,e,{action:n}),d=a.selector;void 0!==d&&t.extend(r,t(d).values());var l=i.element;i.loading=!0,t.json(a.render.processor,{data:dd.plainValues(r)},function(a){if(a){a._responses&&l.triggerHandler("server_response",[a]);var n=(new Date).getTime();console.log("Load: ",n-s),i.populate(a,e.insert_at),i.loading=!1,console.log("Populate: ",(new Date).getTime()-n),delete a.data,t.extend(i.params,a),l.triggerHandler("refreshed",[a])}else l.triggerHandler("refreshed",[a])})},populate:function(e,i){if(null!=e&&e.data){this.cell_render&&delete this.cell_render;var a=this.options,s=this.cell_render=new dd.render({invoker:a.render.root,model_src:a.render.model_src,model_funcs:a.render.model_funcs,types:a.render.types,id:a.id,key:a.key,request:a.request});for(var n in void 0!==this.options.page_size&&this.showPaging(parseInt(e.count)),this.no_records.hide(),0==e.data.length&&0==this.body().children().length&&this.no_records&&this.element.append(this.no_records.show()),this.prev_row=null,e.data){var o=e.data[n];t.isArray(o)&&(this.addRow(o,i),this.prev_row=o)}this.adjustWidths(),s.root=this.element,a.js_functions||(a.js_functions=a.render.root_field.js_functions),s.initModel(s.root,a)}else console.log("No table data for table:",this.params.field)},hasFlag:function(t){return this.options.flags.indexOf(t)>=0},hasHeader:function(){var t=this.options;return void 0!==t.name&&void 0!==t.page_size},showHeader:function(){var e=this.head();e.html("");var i=t("<tr class=header></tr>").appendTo(e),a=t("<th></th>").appendTo(i);void 0!==this.options.name&&this.hasFlag("show_header")&&t("<div class=heading></div>").html(this.options.name).appendTo(a);var s=this;this.hasFlag("filter")&&(this.createAction("filter").appendTo(a),this.element.on("filter",function(t){s.showFilter(),t.stopImmediatePropagation()}),this.createAction("clear_filter").hide().appendTo(a),this.element.on("clear_filter",function(t){s.hideFilter(),t.stopImmediatePropagation()})),void 0===this.options.page_size||this.hasFlag("hide_paging")||this.createPaging(a)},createPaging:function(e){var i=t("<div class=paging></div>").appendTo(e);t("<div>Showing from </div>").appendTo(i),t("<div id=page_from></div>").appendTo(i),t("<div>to</div>").appendTo(i),t("<div id=page_to></div>").appendTo(i),t("<div>of</div>").appendTo(i),t("<div id=page_total></div>").appendTo(i),t("<div>at</div>").appendTo(i),t("<input id=page_size type=text></input>").val(this.options.page_size).appendTo(i),t("<div>entries per page</div>").appendTo(i),this.createAction("goto_first").attr("disabled","").appendTo(i),this.createAction("goto_prev").attr("disabled","").appendTo(i),t("<input id=page_num type=text></input>").val(1).appendTo(i),this.createAction("goto_next").attr("disabled","").appendTo(i),this.createAction("goto_last").attr("disabled","").appendTo(i),this.bindPaging()},pageTo:function(t,e){t.hasAttr("disabled")||(this.params.page_num=e,this.params.size=t.siblings("#page_size").val(),t.siblings("#page_num").val(e),this.refresh())},page:function(t,e){this.pageTo(t,parseInt(t.siblings("#page_num").val())+e)},bindPaging:function(){var e=this,i=e.head(),a=e.params;i.find(".paging [type='text']").bind("keyup input cut paste",function(i){13===i.keyCode&&("page_size"==t(this).attr("id")&&(a.size=parseInt(t(this).val()),a.page_num=1),"page_num"==t(this).attr("id")&&(a.page_num=parseInt(t(this).val())),e.refresh())}),this.element.on("goto_first",function(t,i){e.pageTo(i,1)}).on("goto_prev",function(t,i){e.page(i,-1)}).on("goto_next",function(t,i){e.page(i,1)}).on("goto_last",function(t,a){var s=parseInt(i.find("#page_size").val()),n=parseInt(i.find("#page_total").html());e.pageTo(a,Math.floor(n/s)+1)})},showPaging:function(t){var e=this.head();e.find("#page_total").text(t);var i=this.params.page_num,a=this.params.size,s=e.find("[action=goto_first],[action=goto_prev]"),n=e.find("[action=goto_last],[action=goto_next]");i<=1&&(i=1,s.attr("disabled",""),e.find("#page_num").val(1)),a>=t&&e.find("#page_num").val(1),e.find("#page_from").text((i-1)*a+1),e.find("#page_to").text(Math.min(i*a,t)),i>=t/a?n.attr("disabled",""):n.removeAttr("disabled"),i>1&&s.removeAttr("disabled")},bindSort:function(e,i){var a=this;e.click(function(){e.siblings().attr("sort","").children().remove();var s="asc";a.params.sort==i.number&&(s="asc"===e.attr("sort")?"desc":"asc"),e.attr("sort",s).children().remove(),t("<i>").addClass(a.options.title["sort_"+s].join(" ")).appendTo(e),a.params.sort=i.number,a.params.sort_order=s,a.refresh()})},showTitles:function(){var e=this.head(),i=this.options,a=e.find(".titles").empty();a.exists()||(a=t("<tr class=titles>").appendTo(e)),a.setClass(i.titles.class),this.hasFlag("show_titles")||a.hide();var s=this,n=i.fields,o=i.title.class.join(" ");for(var r in n){var d=n[r],l=d.id;if("style"!=d.id&&!d.data){var p=t("<th></th>").setClass(o).appendTo(a);p.toggle(dd.visible(d)),p.data("field",d),d.class&&p.setClass(d.class),"actions"!==l?(t.isArray(d.name)&&(d.name=d.name[d.name.length-1]),p.html(d.name||dd.toTitleCase(l)),s.hasFlag("sortable")&&(l===s.params.sort?p.attr("sort",s.params.sort_order):p.attr("sort","")),void 0!==d.width&&p.css("width",d.width),s.hasFlag("sortable")&&s.bindSort(p,d)):d.filter=!1}}this.spanColumns(e.find(".header th")),this.updateWidths(e.find(".titles").children())},createRowBlueprint:function(){var e=this,i=t("<tr>").addClass(e.row_classes),a=e.cell.class;e.defaults={};var s=e.options,n=s.fields;for(var o in n){var r=n[o];if(e.defaults[r.id]=r.new,delete r.new,"style"!=r.id&&!r.data){var d=t("<td>").appendTo(i);d.attr("field",r.id),d.toggle(dd.visible(r)),d.addClass(a),r.style&&d.addStyle(r.style,s.cell.styles),r.class&&d.addClass(r.class.join(" ")),void 0!==r.html&&(r=dd.copy(r),delete r.width,d.append(e.options.render.create(r)))}}e.row_blueprint=i},spanColumns:function(t){var e=this.head().find(".titles");e.exists()||(e=this.body().children("tr").eq(0)),t.attr("colspan",e.children().length)},spanData:function(t,e,i){if(t.span<=1)return e[i];var a=e.slice(i,i+t.span);return a.join(" ")},showData:function(e){var i=this,a=i.body(),s=i.options,n=parseInt(a.css("max-height"));if(0==s.page_size||n>0){var o=parseInt(t("<tr><td>Loading...</td></tr>").appendTo(a).height());o<1&&(o=s.min_row_height),i.params.size=Math.ceil((n-i.head().height())/o)+3}a.addClass(s.body.class.join(" ")),a.empty(),i.load(e),i.spanColumns(i.head().find(".header>th"))},updateData:function(e){e=e||{start_row:0,start_col:0};var i=(new Date).getTime(),a=this,s=a.options,n="post"==s.data_from?"action":"values",o=t.extend(s.request,a.params,e,{action:n}),r=s.selector;void 0!==r&&t.extend(o,t(r).values());var d=a.element;a.loading=!0,t.json("/",{data:dd.plainValues(o)},function(t){if(t){o._responses&&d.triggerHandler("server_response",[resut]);var s=(new Date).getTime();console.log("Load: ",s-i);var n=e.start_row,r=e.start_col,l=a.body().children();for(var p in t.data)a.updateRow(l.eq(n++),t.data[p],r);a.loading=!1,d.triggerHandler("updated",[o]),console.log("Update: ",(new Date).getTime()-s)}else d.triggerHandler("updated",[t])})},setRowStyles:function(e,i){var a=this.options.row_styles;a||(a=this.options.row.styles),e.attr("class",""),e.addClass(this.row_classes),t.isPlainObject(i)&&(i=dd.firstKey(i)),e.addStyle(i,a)},addRow:function(e,i){var a=this.row_blueprint.clone(!0);this.updateRow(a,e);var s=this.body();void 0===i?a.appendTo(s):t.isNumeric(i)?a.insertBefore(s.children().eq(i)):a.insertBefore(s.find(i))},updateRow:function(e,i,a){var s,n=this;a=a||0;for(var o=a,r=this.options.fields,d=e.children(),l=r.length-a,p=0,h=0;h<l;++h){var c=r[a++],f=i[h];if("style"!=c.id){if(c.data)e.data(c.id,f),c.attr&&e.attr(c.id,f);else if(!p||!--p){var u=d.eq(o++);if(null==f)f={name:""};else if(!t.isPlainObject(f))if("{"===f[0])try{f=JSON.parse(f)}catch{f={name:f}}else f={name:f};if(void 0===f.id&&(f.id=c.id,s&&(f.id+="_"+s)),c.precision&&dd.isNumber(f.name)&&(f.name=parseFloat(f.name).toFixed(c.precision)),i[h]=f,this.prev_row&&this.prev_row[h]&&this.prev_row[h].row_span>1?(f.row_span=parseInt(this.prev_row[h].row_span)-1,i[h]=f,u.addClass("hide")):f.row_span&&u.attr("rowspan",f.row_span),f.col_span){p=parseInt(f.col_span),u.attr("colspan",p);for(var g=1;g<p;++g)d.eq(o++).remove()}null==f?f=this.options.defaults[c.id]:c.escapeHtml&&(f=dd.escapeHtml(f)),void 0!==s||"key"!==c.id&&!c.key||(e.attr("key",f.name),s=f.name),n.setCellValue(u,f)}}else f&&n.setRowStyles(e,f)}n.adjustColWidths(e),this.prev_row=i},adjustColWidths:function(e){var i=this.widths;e.children().each(function(e){var a=t(this).width();e==i.length?i.push(a):i[e]<a&&(i[e]=a)})},setCellValue:function(e,i){if(t.isPlainObject(i)||(i={value:i}),i.name||(i.name=""),i.value||(i.value=i.name),"actions"==e.attr("field"))return this.createRowActions(e,i.value);if(e.hasClass("expandable"))return e.find(".text").eq(0).text(i.name);if((i.class||this.options.cell.class)&&e.setClass(this.options.cell.class.concat(i.class)),i.style&&e.addStyle(i.style,this.options.cell.styles),i.key&&e.attr("key",i.key),i.type){i.path=this.options.path+"/cell/controls/"+i.type;var a=this.cell_render.create(this.options.cell,i,!0,e);a&&e.append(a)}i.data&&e.data(JSON.parse(i.data));var s=e.children().eq(0);return s.exists()?(s.value(i.value),e):e.text(i.value).attr("title",i.title?i.title:i.name)},applyStyle:function(e,i,a){var s=this;t.isArray(a)||(a=a.split(" ")),a.forEach(function(t){e.addClass(t);var a=i[t];a&&a.forEach(function(t){"~"==t[0]?s.removeStyle(e,i,t.substr(1)):"^"==t[0]?e.removeClass(t.substr(1)):e.addClass(t)})})},removeStyle:function(t,e,i){var a=e[i];a&&t.removeClass(a.join(" "))},bindAction:function(e,i,a,s){void 0===a&&(a=this.element);var n=this.element;e.click(function(){var o=i.id;if(a.trigger("action",[e,o,i]),a.trigger(o,[e,i]),void 0!==i.action){var r=a.attr("key");void 0===r&&(r=n.options.key);var d=t.extend({},n.params,i,{id:o,action:i.action,key:r}),l=n.closest(".page").eq(0);d.path+="/",void 0!==s&&(d.path+=s+"/"),d.path+=o,l.trigger("child_action",[e,d])}})},findField:function(t,e){for(var i in e)if(t===e[i].id)return e[i]},createAction:function(e,i,a,s){var n;if(i?(n=this.findField(e,i),n||(n=this.options[e])):t.isPlainObject(e)?(n=e,e=n.id):n=this.options[e],!n||t.isEmptyObject(n))return t("");var o=t("<span>");return void 0===n.name&&(n.name=dd.toTitleCase(e)),o.html(n.name),o.attr("title",n.desc),o.attr("action",e),n.class&&o.setClass(n.class),n.icon&&t("<"+n.icon.tag+">").setClass(n.icon.class).appendTo(o),n.id=e,this.bindAction(o,n,a,s),o},createExpandActions:function(e){var i=e.parent();i.children().each(function(){if("none"!=t(this).css("display"))return e=t(this),!1}),e.addClass("expandable");var a=t("<span>").addClass("text").text(e.text());e.text("").append(a),this.createAction("expand",void 0,i).prependTo(e),this.createAction("collapse",void 0,i).prependTo(e).hide()},createRowActions:function(e,i){if(i){t.isArray(i)||(i=i.split(",")),i.indexOf("expand")>=0&&this.createExpandActions(e),i.indexOf("slide")>=0&&i.push("slideoff"),e.hasClass("actions")||e.addClass("actions"),e.empty();var a=this.options,s=a.row_actions,n=e.parent().attr("key"),o=[],r=[],d=o,l=-1;for(var p in s){var h=dd.copy(s[p]),c=h.id;i.indexOf(c)<0||(h.key=n,h=dd.merge(h,a[c]),d.push(h),"slide"==c&&(d=r,l=p))}if(1==r.length&&o.splice(l,1),o.length&&a.render.createItems(e,{},void 0,o),!(r.length<2)){var f=t('<div class="slide">').toggle(!1).appendTo(e);f.data("actions",r)}}},slide:function(e){this.getActionsHeight(e);var i=e.find(".slide");0==i.children().length&&(this.options.render.createItems(i,{},void 0,i.data("actions")),i.find("[action]").click(function(){i.parent().trigger("action",[t(this),"",t(this).attr("action")])}),i.data("width",i.width()),i.width(0)),i.show().animate({width:i.data("width")},this.options.slideSpeed)},loadSubPages:function(e,i){var a=t("<tr class=expanded></tr>"),s=t("<td></td>").attr("colspan",e.children("td").length).addClass(this.options.expand.class.join(" ")).prependTo(a);a.insertAfter(e);var n=e.attr("key"),o=(t("<div></div>"),0),r=function(){var e=i[o];t.showPage({path:e,key:n},s).done(function(){++o<i.length&&r()})};r()},bindRowActions:function(){var e=this,i=e.options,a=this.element;a.on("slide","tr",function(i){t(i.target).toggle(),e.slide(t(this)),i.stopPropagation()}).on("expand","tr",function(a){var s=t(this);if(s.find("[action=expand]").hide(),s.find("[action=collapse]").show(),!s.next().hasClass("expanded")){var n=i.expand;n.pages&&(e.loadSubPages(s,n.pages),a.stopPropagation())}}).on("collapse","tr",function(e){var i=t(this);i.find("[action=collapse]").hide(),i.find("[action=expand]").show();var a=i.next();a.hasClass("expanded")&&a.remove(),e.stopPropagation()}).on("action","tr",function(a,s){if(s.parent(".slide").exists()){e.slide(t(this));var n=t(this).find("[action=slide]"),o=t(this).find(".slide");o.animate({width:0},2*i.slideSpeed,function(){o.hide(),n.show()}),a.stopPropagation()}}).on("delete","tr",function(e){return t(this).remove(),t(this)}).on("delete",function(t){t.stopPropagation()}).on("setRowStyles setRowStyle",function(i,s,n){t(i.target).is(a)&&e.setRowStyles(e.getRowByKey(s),n)}).on("setRowActions",function(i,s,n){if(t(i.target).is(a)){var o=e.getRowByKey(s);e.createRowActions(e.getCellById(o,"actions"),n)}}).on("setCellValue",function(i,s,n,o){if(t(i.target).is(a)){var r=e.getRowByKey(s);e.setCellValue(e.getCellById(r,n),{name:o})}}).on("setRowData",function(i,s,n){t(i.target).is(a)&&e.setRowData(e.getRowByKey(s),n)}).on("addRow",function(i,s){t(i.target).is(a)&&(e.addRow(s),e.adjustWidths())}).on("addNewRow",function(i,s){if(t(i.target).is(a)){var n=e.row_blueprint.clone(!0);e.body().prepend(n),e.setRowData(n,s),e.adjustWidths()}}).on("removeRow",function(t,i){e.getRowByKey(i).remove()})},setRowData:function(e,i){for(var a in i=t.extend({},this.options.defaults,i),"key"in i&&e.attr("key",i.key),i){var s=i[a];"style"==a?this.setRowStyles(e,s):"actions"==a?this.createRowActions(this.getCellById(e,a),s):this.setCellValue(this.getCellById(e,a),s)}},getCellById:function(t,e){return t.children('[field="'+e+'"]').eq(0)},getRowByKey:function(t){return this.body().children('[key="'+t+'"]').eq(0)},getActionsHeight:function(t){return(.99*t.innerHeight()).toString()+"px"},initWidths:function(t,e){var i=this.options.fields,a=(this.widths,-1);for(var s in i){var n=i[s];if("style"!=n.id&&"type"!=n.type){++a;var o=t.eq(a),r=e.eq(a);void 0!==n.width?o.exists()?(o.css("width",n.width),r.css("width",o.get(0).style.width)):r.css("width",n.width):"auto"!==n.width&&(o.css("width","auto"),r.css("width","auto"))}}},updateWidths:function(e){var i=this.widths;e.each(function(e){var a=t(this).width();e===i.length?i.push(a):a>i[e]&&(i[e]=a)})},adjustWidths:function(){if(void 0===this.options.adjust_widths||this.options.adjust_widths){var t=this.head().find(".titles").children(),e=this.body().find("tr:first-child"),i=e.children();this.initWidths(t,i),this.updateWidths(i);var a=this.widths;a.length||(a=[]);var s=a.reduce(function(t,e){return t+e},0),n=this.options.fields,o=0;for(var r in n){var d=n[r];if("style"!=d.id&&!d.data&&void 0===d.width){var l=t.eq(o),p=a[o]/s*100+"%";l.exists()&&(l.css("width",p),p=l.get(0).style.width),i.eq(o).css("width",p),++o}}}},createEditor:function(e,i){var a=t("<tr>");a.addClass("datatable-editor").addClass(i).removeClass("title");this.body().children().eq(0);var s=this.options[i].box;return box_class=s.class.join(" "),e.children().each(function(){var e=t(this).data("field");if(!e||"actions"!=e.id){var s=t("<td>"),n=e[i];(void 0===n||n)&&s.append(t("<input type=text></input>").addClass(box_class)),s.appendTo(a)}}),a.insertAfter(e),a},createFilter:function(){var e=this.head().find(".filter");if(e.exists())return e;var i=this,a=i.head().find(".titles");e=i.createEditor(a,"filter").hide();var s=e.children();return e.find("input").bind("keyup cut paste",dd.debounce(function(e){var a=t(this);i.params.offset=0;var n=a.parent(),o=s.index(n);i.params["f"+o]=a.value(),i.params.page_num=1,i.refresh()},i.options.search_delay)).on("click",function(t){t.stopImmediatePropagation()}),e},showFilter:function(){var t=this.head();t.find("[action=filter]").toggle(),t.find("[action=clear_filter]").toggle();var e=this.createFilter();e.toggle()},hideFilter:function(){var e=this.head(),i=this.params,a=e.find(".filter"),s=a.children();a.hide().find("input").each(function(){t(this).val("");var e=t(this).parent(),a=s.index(e);delete i["f"+a]}),i.page_num=1,this.refresh(),e.find("[action=filter]").toggle(),e.find("[action=clear_filter]").toggle()},showFooterActions:function(){this.options.render.expandFields(this.options,"footer_actions",this.options.footer_actions);var e=this.options.footer_actions;if(e.length){this.element.children("tfoot").remove();var i=t("<tfoot>").appendTo(this.element),a=t("<tr>").addClass("actions").appendTo(i),s=t("<td>").appendTo(a),n=this.options.key;e.map(function(t){return t.key=n,t}),this.options.render.createItems(s,this.options,void 0,e),this.spanColumns(s)}},_scroll:function(t){var e=this,i=(e.opts,e.body());i.scrollHeight()-i.scrollTop()!=i.height()||e.loading||e.params.total&&e.params.offset+e.params.size>e.params.total||(e.params.offset+=e.params.size,e.load())}})})(jQuery);