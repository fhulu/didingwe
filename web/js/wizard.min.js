$.widget("didi.wizard",{_create:function(){this.stack=new Array;this.first_step=0;this.createPages();this.bindActions();this.stack=new Array;this.jumpTo(0)},child:function(t,e){if(!e)e=0;return this.element.find(t).eq(e)},createPages:function(){var t=this;var e=t.options;var i=e.render.create(e,"step_container",true);e.step=e.render.initField(e.step,e);var s=e.bookmarks.state_styles["pending"];if($.isArray(s))s=s.join(" ");$.each(e.steps,(function(e,n){i.clone().attr("step",n.id).hide().appendTo(t.element);t.child(".wizard-bookmark",e).addClass(s)}))},jumpTo:function(t){if($.isPlainObject(t))t=t.index;if(typeof t==="string"){var e=this.child('.wizard-page[step="'+t+'"]');if(!e.exists())return;t=this.element.children(".wizard-page").index(e)}if(this.stack.length){var i=this.stack[this.stack.length-1];if(t===i)return;if(i<t){this.hidePage(i,"done")}else do{i=this.stack.pop();this.hidePage(i,"visited")}while(i>t)}this.showPage(t);delete this.next_step},showPage:function(t){var e=this.child(".wizard-page",t);var i=this.options.steps[t];if(!e.find(".wizard-step").exists()||i.clear){this.child(".wizard-navigate").empty();this.loadPage(e,t)}else{e.show().triggerHandler("reload")}this.updateBookmark(t,"active");this.stack.push(t)},updateBookmark:function(t,e){var i=this.options.bookmarks.state_styles;var s=this.child(".wizard-bookmark",t);$.each(i,(function(t,e){if($.isArray(e))e=e.join(" ");s.removeClass(e)}));var n=i[e];if($.isArray(n))n=n.join(" ");s.addClass(n)},updateNavigation:function(t,e,i){var s=this;var n=s.options;var a=s.options.steps.length-1;if(e.prev===false){s.element.find(".wizard-bookmark").each((function(e){if(e<t)s.updateBookmark(e,"committed")}))}else if(t!=s.first_step)e.navigate.unshift({prev:n.prev});if(e.next!=false&&t!=a){n.next.path=e.path;var r=dd.copy(n.next);r.post_prefix=e.post_prefix;e.navigate.push({next:r})}e.navigation.path=e.path;var o=n.render.create(e,"navigation",true);o.find(".wizard-next").bindFirst("click",(function(){if(s.next_step!==undefined)return;s.next_step=typeof e.next==="string"?e.next:t+1}));i.append(o)},hidePage:function(t,e){this.child(".wizard-page",t).hide();this.updateBookmark(t,e)},loadPage:function(t,e){var i=this;var s=i.options;var n=s.steps[e];if(typeof n=="string")n={id:n};else if(!n.id)n.id=dd.firstKey(n);var a=s.path;if(n.id.indexOf("/")>=0)a=n.id;else if(n.url!==undefined)a=n.url;else if(a.indexOf("/")===-1)a+="/"+n.id;else a=a.substr(0,a.lastIndexOf("/")+1)+n.id;t.empty();$.loadPage({path:a,key:s.key},t).then((function(s,a){s.fields=dd.merge(i.options.step,s.fields,n);s.fields.path=s.path;var r=$.createPage(a,s,t);i.updateNavigation(e,s.fields,t);t.show()}))},bindActions:function(){var t=this;t.element.on("wizard-jump",(function(e,i){t.jumpTo(i)})).on("wizard-next",(function(){t.jumpTo(t.stack[t.stack.length-1]+1)})).on("wizard-prev",(function(){t.jumpTo(t.stack[t.stack.length-2])})).on("post_success",(function(e,i){if(i&&i.next_step)t.next_step=i.next_step;if(!t.stack.length||!t.next_step)return;if(t.next_step===true)t.element.trigger("wizard-next");if(t.next_step)t.jumpTo(t.next_step)})).find(".wizard-bookmark").click((function(){if($(this).hasClass("wizard-state-done"))t.jumpTo($(this).attr("step"))}))},nextStep:function(t){this.next_step=t}});