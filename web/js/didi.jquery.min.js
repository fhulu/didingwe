(function(e){"use strict";e.fn.exists=function(){return null!=this.get(0)},e.fn.hasAttr=function(e){return void 0!==this.attr(e)},e.fn.filterText=function(t){return this.filter(function(){return e(this).text()==t})},e.fn.setValue=function(t){if(e.isArray(t))return this;if(e.isPlainObject(t)){var i=this;e.each(t,function(t,r){switch(t){case"value":i.setValue(r);break;case"class":i.setClass(r);break;case"children":e.each(r,function(e,t){i.find(e).setValue(t)});break;default:i.attr(t,r)}})}if(this.hasAttr("template")&&(t=this.attr("template").replace(/\$value/,t)),this.is("a"))return null==t&&(t=""),this.attr("href",t);var r=this.attr("type");if("checkbox"===r){var s=this.attr("values");return""!=s&&(t=s.indexOf(t)),this.prop("checked",t)}if("radio"==r){var n=this.closest(".radiogroup"),a=n.find("[type=radio][name='"+this.attr("name")+"'][value='"+t+"']");return a.prop("checked",!0),this}if(this.is("select")){if(this.val(t),this.val()==t)return this;var o=this.children("option").filterText(t);return o.exists()?(this.attr("server")==t&&this.attr("server",o.val()),this.val(o.val()),this):this}return"string"==typeof t&&(t=dd.escapeHtml(t,this.attr("parseHtml"),this.attr("escapeHtml"))),this.hasAttr("value")?this.attr("value",t).val(t):this.html(t)},e.fn.getValue=function(){var e=this.attr("type");if("checkbox"===e){var t=this.is(":checked")?1:0,i=this.attr("values");return""==i?t:i.split(",")[t]}return"radio"===e?this.filter(":checked").val():this.is("input,select,textarea")?this.val():this.is("[value]")?this.attr("value"):this.text()},e.fn.value=function(e){return void 0===e?this.getValue():this.setValue(e)},e.fn.updateCheckGroupValue=function(){var t=[];return this.find("input[type=checkbox]").each(function(){e(this).is(":checked")&&t.push(e(this).attr("check"))}),this.attr("chosen",t.join())},e.fn.values=function(){this.find(".checkgroup").updateCheckGroupValue();var t={},i=[];return this.filter("input,textarea,select,.checkgroup,:not(option)[value]").each(function(){var r,s=e(this),n=s.hasAttr("name")?s.attr("name"):s.attr("id");if(void 0===n||""==n.trim())return!0;if(s.hasClass("checkgroup"))r=s.attr("chosen");else if("radio"===s.attr("type")){if(!s.is(":checked"))return;r=s.attr("value")}else r=s.value();var a=s.attr("server");void 0!==a&&a!=r&&i.push(n),t[n]=r}),t.delta=i.join(),t},e.fn.send=function(t,i,r){i instanceof Function&&(r=i,i=void 0);var s=e(this).values();return void 0!==i&&(s=e.extend({},i.data,s)),i=e.extend({},i,{data:s}),dd.send(t,i,r)},e.fn.json=function(t,i,r){i instanceof Function&&(r=i,i=void 0);var s=e(this).values(),n=i.post_prefix;if(n){delete i.post_prefix;var a={};e.each(s,function(e,t){"delta"!=e&&(a[n+e]=t)}),s=a}return void 0!==i&&(s=e.extend({},i.data,s)),i=e.extend({},i,{data:s}),e.json(t,i,function(e){r(e)}),this},e.fn.setChildren=function(t,i,r){var s=this;if(null!==t)return e.each(t,function(e,t){var n=s.find("#"+e+",[name='"+e+"']");i&&n.attr("server",t),n.setValue(t),r(n,t,e)}),this},e.fn.loadChildren=function(t,i,r){var s,n=this;return e.json(t,i,function(e){n.setChildren(e),s=e,null!=r&&r(s)}),this},e(function(){e.each(["show","hide","toggleClass","addClass","removeClass"],function(){var t=e.fn[this];e.fn[this]=function(){var i=this.find(":hidden").add(this.filter(":hidden")),r=this.find(":visible").add(this.filter(":visible")),s=t.apply(this,arguments);return i.filter(":visible").each(function(){e(this).triggerHandler("show")}),r.filter(":hidden").each(function(){e(this).triggerHandler("hide")}),s}})}),e.fn.insertAtCursor=function(e){var t=this.getCursorPosition(),i=this.val();this.val(i.substr(0,t)+e+i.substr(t))},e.fn.getCursorPosition=function(){var t=e(this).get(0),i=0;if("selectionStart"in t)i=t.selectionStart;else if("selection"in document){t.focus();var r=document.selection.createRange(),s=document.selection.createRange().text.length;r.moveStart("character",-t.value.length),i=r.text.length-s}return i},e.fn.bookmarkOnClick=function(){this.click(function(){"sidebar"in window&&"addPanel"in window.sidebar?window.sidebar.addPanel(location.href,document.title,""):alert("Press "+(-1!=navigator.userAgent.toLowerCase().indexOf("mac")?"Command/Cmd":"CTRL")+" + D to bookmark this page.")})},e.fn.customCreate=function(e){var t=e.create;void 0!==t&&(this.attr("customCreate",t),this.run(t,e))},e.fn.run=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();this[t].apply(this,e)},e.fn.call=function(e,t){this[e].apply(this,t)},e.fn.scrollHeight=function(){return this[0].scrollHeight},e.fn.hasScrollBar=function(){return this[0].scrollHeight>this.height()},e.scrollbarWidth=function(){var t,i,r;return t=e('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo("body"),i=t.children(),r=i.innerWidth()-i.height(99).innerWidth(),t.remove(),r},e.fn.replace=function(t,i,r){var s=function(e,t,i,r){if(e&&void 0!==t)for(var n="string"==typeof e?new RegExp(e,"g"):e,a=i.childNodes,o=a.length,l=void 0===r?"html,head,style,title,link,meta,script,object,iframe,pre,a,":r;o--;){var d=a[o];if(1!==d.nodeType&&-1!==l.indexOf(d.nodeName.toLowerCase())||s(e,t,d,l),3===d.nodeType&&n.test(d.data)){var h=function(){var e=d.data.replace(n,t),i=document.createElement("span"),r=document.createDocumentFragment();for(i.innerHTML=e;i.firstChild;)r.appendChild(i.firstChild);return r}(),c=d.parentNode;c.insertBefore(h,d),c.removeChild(d)}}};return this.each(function(){s(t,i,e(this).get(0),r)})},e.fn.valueFromCurrency=function(){return this.value().replace(/[^\d.]/g,"")},e.fn.bindFirst=function(t,i){return this.on(t,i),this.each(function(){var i=e._data(this,"events")[t.split(".")[0]],r=i.pop();i.splice(0,0,r)})},e.fn.findByAttribute=function(e,t){return this.find("["+e+"='"+escape(t)+"']")},e.fn.addStyle=function(t,i){e.isArray(t)||(t=t.split(/[, ]/));var r=[],s=[],n=[];if(i||(i=this.data("didi-field").style),t.forEach(function(t){r.push(t);var o=i[t];o&&(e.isPlainObject(o)&&(n.push(o.style),o=o.class),o&&o.forEach(function(e){"~"==e[0]?a.removeStyle(i,e.substr(1)):"^"==e[0]?s.push(e.substr(1)):r.push(e)}))}),r.length&&this.addClass(r.join(" ")),s.length&&this.removeClass(s.join(" ")),!n.length)return this;var a=this;return n.forEach(function(e){this.css(e)}),this},e.fn.removeStyle=function(t,i){e.isArray(t)||(t=t.split(" ")),i||(i=this.data("didi-field").style);var r=this;return t.forEach(function(e){r.removeClass(e);var t=i[e];t&&t.forEach(function(e){r.removeClass(e)})}),this},e.fn.setClass=function(e,t){if(void 0!==e){"string"==typeof e&&(e=e.split(" "));var i=[],r=[];for(var s in e){var n=e[s];n&&("^"==n[0]||"-"==n[0]?i.push(n.substr(1)):r.push(n))}if(t){var a=r;r=i,i=a}return this.addClass(r.join(" ")),this.removeClass(i.join(" ")),this}},e.fn.unsetClass=function(e){return this.setClass(e,!0)},e.fn.getQuantity=function(e,t){var i=this.data(e);return void 0===i?t||0:parseInt(i)},e.fn.load=function(t){e.showPage(t,this).done(function(e,t,i){setStyle(e,i),setClass(e,i),this.trigger("dying"),this.replaceWith(e)})},e.fn.getAttributes=function(e){var t={};if(e)for(var i=0;i<e.length;++i){var r=e[i];t[r]="text"==r?this.text():this.attr(r)}else{var s=this[0].attributes;for(i=0;i<s.length;++i)t[s[i].name]=s[i].value}return t},e.fn.enableWhen=function(e){e()?this.attr("disabled","disabled"):this.removeAttr("disabled")},e.fn.enableOnSet=function(t,i){this.attr("disabled","disabled"),t=e(t).filter(":visible").filter("input,select,textarea");var r=this;t.bind("keyup input cut paste click change onClose",function(){var i=0;t.each(function(){""!=e(this).val()&&++i}),i<t.length?r.attr("disabled","disabled"):r.removeAttr("disabled")})},e.fn.triggerEx=function(e,t){"."===e[0]&&(e=e.substr(1),this.run(e,...dd.asArray(t))),this.trigger(e,t)},e.send=function(t,i,r){i instanceof Function&&(r=i,i=void 0),i=e.extend({progress:"Processing...",method:"post",async:!0,showResult:!1,invoker:void 0,data:{},eval:!0,dataType:void 0,error:void 0,event:void 0},i);var s=this;void 0!==i.invoker&&i.invoker.prop("disabled",!0);var n={};return!1!==i.progress&&(n.box=e(".processing"),n.box.click(function(){e(this).fadeOut("slow")}),n.timeout=setTimeout(function(){n.box.find(".message").text(i.progress),n.box.show()},1e3),void 0===i.error&&(i.error=function(e,t,r){console.log("AJAX ERROR",t,"TEXT",r),n.box.html("<p class=error>Status:"+t+"<br>Text:"+r+"</p").show(),void 0!==i.event&&(i.event.stopImmediatePropagation(),s=!1)})),e.ajax({type:i.method,url:t,data:i.data,async:i.async,error:i.error,cache:!1,dataType:i.dataType,success:function(e){void 0!==n.timeout&&clearTimeout(n.timeout),void 0!==n.box&&n.box.hide(),void 0!==r&&r(e,i.event),void 0!==i.invoker&&i.invoker.prop("disabled",!1)}}),s},e.loadPage=((t,i)=>{null==i&&(i=e("body"));var r=e.Deferred(),s=t.path;"/"===s[0]&&(s=t.path.substr(1));var n=e.extend({key:t.key},t.request,{path:s,action:"read"});return t.processor||(t.processor="/"),e.json(t.processor,{data:n},function(s){i.trigger("server_response",s),s.path&&(s.values=e.extend({},t.values,s.values),r.resolve(s,t))}),r.promise()}),e.createPage=((e,t,i)=>{var r=t.fields.id=e.page_id=t.path.replace("/","_");t.fields.local_id=t.path.split("/").pop();var s=t.fields.values||t.values;void 0===t.fields.name&&(t.fields.name=dd.toTitleCase(t.path.split("/").pop().replace("_"," "))),t.fields.path=t.path,t.fields.sub_page=!1,t.fields.values=s,void 0===t.key&&(t.key=e.key);var n=new dd.render({invoker:i,types:t.types,id:r,key:t.key,request:e.request,processor:e.processor}),a=n.render(t,"fields");return t._responses&&n.respond(t),a.addClass("page"),i&&!a.is("body")&&a.appendTo(i),a}),e.showPage=((t,i,r)=>{"string"==typeof t&&(t={path:t}),null==i&&(i=t.parent?e(t.parent):e("body"));var s=e.Deferred(),n=function(t,r){var n=e.createPage(r,t,i);e.isPlainObject(t.fields.parent)&&i.setClass(t.fields.parent.class),s.resolve(n,t,r)};return r?n(r,t):e.loadPage(t,i).done(n),s.promise()}),e.showDialog=((t,i)=>{"/"===t[0]&&(t=t.substr(1));var r=e.extend({path:t},i),s=e.Deferred();return e.loadPage({path:"/modal",show:!1,processor:i.processor}).done(function(t,n){var a=e("<div>");e.showPage(r,a).done(function(r,a){a.fields.modal&&(t.fields=dd.merge(t.fields,a.fields.modal)),t.fields.title_bar&&dd.replaceVars(a.fields,t.fields.title_bar,{recurse:!0}),t.fields.close_button&&dd.replaceVars(a.fields,t.fields.close_button,{recurse:!0}),t=e.createPage(n,t),t.removeAttr("id");var o=t.find(".modal-dialog");o.append(r),o.draggable({handle:".modal-title-bar"}),t.appendTo(e("body")).show(),s.resolve(o,a,i)})}),s.promise()}),e.closeDialog=((e,t)=>{t&&alert(t);var i=e.closest(".modal");i.trigger("closing"),i.exists()&&i.remove()}),e.json=((t,i,r)=>(i instanceof Function?(r=i,i={dataType:"json"}):i=e.extend(i,{dataType:"json"}),e.send(t,i,r))),e.scrollbarWidth=(()=>{var t,i,r;return t=e('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo("body"),i=t.children(),r=i.innerWidth()-i.height(99).innerWidth(),t.remove(),r}),e.loadLink=((t,i)=>e.Deferred(function(r){var s={css:{tag:"link",type:"text/css",selector:"href",rel:"stylesheet"},script:{tag:"script",type:"text/javascript",selector:"src"}},n=s[i];if(t.indexOf("?")<0){var a=e(n.tag+"["+n.selector+'="'+t+'"]');if(a.exists())return r.resolve(t)}var o=document.createElement(n.tag);delete n.tag,o[n.selector]=t,delete n.selector,e.extend(o,n),o[n.src]=t,o.type=n.type,"css"==i&&(o.rel="stylesheet"),o.onreadystatechange=o.onload=function(){r.resolve(t)},o.onerror=function(){r.resolve(t)},document.head.appendChild(o)}).promise())})(jQuery);